(function(a){var b=function(b,e){var f=a(b),h,c,q,k=a.extend({},{debug:!1,glyphpath:"",meipath:"",bgimgpath:"",bgimgopacity:.6,apiprefix:"",origwidth:null,origheight:null,documentType:"liber",width:1E3},e);a.extend(k,{canvasid:"neon-canvas"});var m=function(b){console.log("loading SVG glyphs ...");return a.get(k.glyphpath,function(c){var d={};a(c).find("svg").each(function(b,c){var f=a("<lol>").append(a(c).clone()).remove().html();fabric.loadSVGFromString(f,function(b,f){var e=a(c).attr("id"),h=fabric.util.groupSVGElements(b,
f);d[e]=new Toe.Model.Glyph(e,h)})});b.setGlyphs(d)})},l=function(){console.log("loading background image ...");var b=a.Deferred();!k.bgimgpath||k.origwidth||k.origheight?b.resolve():fabric.Image.fromURL(k.bgimgpath,function(a){k.origwidth=a.width;k.origheight=a.height;b.resolve()});return b.promise()},g=function(){var b=a.Deferred();k.meipath?a.get(k.meipath,function(a){console.log("loading MEI file ...");h=a;b.resolve()}):b.resolve();return b.promise()},p=function(){var b;switch(k.documentType){case "liber":case "salzinnes":b=
new Toe.Model.SquareNotePage(k.documentType);break;case "stgallen":b=new Toe.Model.CheironomicPage(k.documentType)}var d=a("<canvas>").attr("id",k.canvasid),e=[k.origwidth,k.origheight];k.bgimgpath||(e=b.calcDimensions(a(h).find("zone")),e[0]+=100,e[1]+=100);b.setPageScale(k.width/e[0]);b.setDimensions(Math.round(e[0]),Math.round(e[1]));d.attr("width",b.width);d.attr("height",b.height);d.attr("style","border: 4px black solid;");f.prepend(d);d={renderOnAddition:!1};k.bgimgpath&&a.extend(d,{backgroundImage:k.bgimgpath,
backgroundImageOpacity:k.bgimgopacity,backgroundImageStretch:!0});c.setCanvas(new fabric.Canvas(k.canvasid,d));if(Toe.debug){var g=a("<div>").attr("id","fps");g.attr("style","color: red; font-size: 200%");f.prepend(g);c.canvas.onFpsUpdate=function(b){a(g).html("FPS: "+b)}}d=new Toe.View.PageView(c);new Toe.Ctrl.PageController(b,d);h&&b.loadMei(h,c);new Toe.View.GUI(k.apiprefix,k.meipath,c,{sldr_bgImgOpacity:k.bgimgpath,initBgImgOpacity:k.bgimgopacity});switch(k.documentType){case "liber":case "salzinnes":new Toe.View.SquareNoteInteraction(c,
b,k.apiprefix);break;case "stgallen":new Toe.View.CheironomicInteraction(c,b,k.apiprefix)}console.log("Neon.js ready ("+(new Date-q)+"ms)")};(function(){q=new Date;c=new Toe.View.RenderEngine;Toe.debug=k.debug;a.when(m(c),g(),l()).then(p,function(){console.log("Failure to load the mei file, glyphs, or background image")})})()};a.fn.neon=function(d){return this.each(function(){var e=a(this);if(!e.data("neon")){var f=new b(this,d);e.data("neon",f)}})}})(jQuery);Toe={Model:{},Ctrl:{},View:{}};(function(a){a.arraysEqual=function(b,d){if(b.length!=d.length)return!1;var e=!0;a.each(b,function(a,b){if(b!=d[a])return e=!1});return e}})(jQuery);(function(a){a.truncateFloat=function(a){return 0<a?Math.floor(a):Math.ceil(a)}})(jQuery);Toe.validBoundingBox=function(a){return a[0]<=a[2]&&a[1]<=a[3]};Toe.neumaticChroma="abcdefg".split("");Toe.Model.Model=function(){this.controller=this.view=null};Toe.Model.Model.prototype.constructor=Toe.Model.Model;Toe.Ctrl.Controller=function(a,b){this.model=a;this.view=b;void 0!==this.model&&(this.model.controller=this,this.model.view=this.view);void 0!==this.view&&(this.view.model=this.model,this.view.controller=this)};Toe.Ctrl.Controller.prototype.constructor=Toe.Ctrl.Controller;Toe.View.View=function(){this.controller=this.model=null};Toe.View.View.prototype.constructor=Toe.View.View;Toe.Model.Glyph=function(a,b){this.key=a;this.obj=b;this.centre=[this.obj.width/2,this.obj.height/2]};Toe.Model.Glyph.prototype.constructor=Toe.Glyph;Toe.Model.Glyph.prototype.clone=function(){return this.obj.clone()};Toe.View.RenderEngine=function(a){this.options={globScale:.08};$.extend(this.options,a)};Toe.View.RenderEngine.prototype.constructor=Toe.View.RenderEngine;Toe.View.RenderEngine.prototype.setGlyphs=function(a){this.glyphs=a};Toe.View.RenderEngine.prototype.setCanvas=function(a){this.canvas=a;this.canvas.HOVER_CURSOR="pointer";this.canvas.selectionLineWidth=2;this.canvas.selectionBorderColor="black"};
Toe.View.RenderEngine.prototype.setGlobalScale=function(a){this.options.globScale=a;$.each(this.glyphs,function(b,d){d.centre=[d.centre[0]*a,d.centre[1]*a]})};Toe.View.RenderEngine.prototype.getGlobalScale=function(){return this.options.globScale};Toe.View.RenderEngine.prototype.getGlyph=function(a){return this.glyphs[a]};
Toe.View.RenderEngine.prototype.calcScaleFromSystem=function(a,b){opts={overwrite:!1};$.extend(opts,b);var d=(a.zone.lry-a.zone.uly)/(a.props.numLines-1),d=2*d-.65*d,e=this.getGlyph("c_clef").clone().height;scale=Math.abs(d/e);opts.overwrite&&this.setGlobalScale(scale);return scale};
Toe.View.RenderEngine.prototype.calcScaleFromNeume=function(a,b){opts={overwrite:!1};$.extend(opts,b);var d=this.getGlyph(a.typeid).clone(),d=Math.abs((a.zone.lry-a.zone.uly)/d.height);opts.overwrite&&this.setGlobalScale(d);return d};Toe.View.RenderEngine.prototype.createLine=function(a,b){var d={fill:"rgb(0,0,0)",strokeWidth:3,opacity:1,interact:!1};$.extend(d,b);return new fabric.Line(a,{fill:d.fill,stroke:d.fill,strokeWidth:d.strokeWidth,opacity:d.opacity,selectable:d.interact})};
Toe.View.RenderEngine.prototype.outlineBoundingBox=function(a,b){var d={fill:"rgb(0,255,0)",opacity:.65,interact:!1};$.extend(d,b);var e=a[2]-a[0],f=a[3]-a[1];a=new fabric.Rect({width:e,height:f,left:a[0]+e/2,top:a[1]+f/2,fill:d.fill,opacity:d.opacity});e={fixed:[],modify:[]};e.fixed.push(a);this.draw(e,{selectable:d.interact,opacity:d.opacity})};
Toe.View.RenderEngine.prototype.draw=function(a,b){var d={modify:!0,repaint:!1,group:!1,selectable:!0,hasControls:!1,hasBorders:!1,lockMovementX:!1,lockMovementY:!1,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,lockScale:!0,opacity:1,eleRef:null};$.extend(d,b);a.modify=this.preprocess(a.modify);a=$.merge($.merge([],a.modify),a.fixed);d.group&&(a=[new fabric.Group(a)]);$.map(a,function(a,b){a.selectable=d.selectable;a.hasControls=d.hasControls;a.lockRotation=!0;a.lockScale=!0;a.lockScalingX=d.lockScalingX;
a.lockScalingY=d.lockScalingY;a.lockUniScaling=d.lockUniScaling;a.lockMovementX=d.lockMovementX;a.lockMovementY=d.lockMovementY;a.borderColor="rgba(102,153,255,1.0)";a.opacity=d.opacity;a.eleRef=d.eleRef});for(var e=0;e<a.length;e++)this.canvas.add(a[e]);d.repaint&&this.repaint();return a};Toe.View.RenderEngine.prototype.unObserve=function(a){this.canvas.off(a)};Toe.View.RenderEngine.prototype.repaint=function(){this.canvas.renderAll()};
Toe.View.RenderEngine.prototype.preprocess=function(a){for(var b=0;b<a.length;b++)a[b]=a[b].scale(this.options.globScale),a[b].currentWidth*=this.options.globScale,a[b].currentHeight*=this.options.globScale;return a};Toe.Ctrl.ClefController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,e){var f=e.left-e.currentWidth/2,h=e.top-e.currentHeight/2;a.setBoundingBox([f,h,f+e.currentWidth,h+e.currentHeight])});$(a).bind("vRenderClef",function(a,e){Toe.debug&&b.renderClefBoundingBox(e);b.renderClef(e)});$(a).bind("vUpdateShape",function(a,e){b.updateShape(e)});$(a).bind("vUpdateSystemPosition",function(a,e){b.updateSystemPosition(e)});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()});Toe.Ctrl.Controller.call(this,
a,b)};Toe.Ctrl.ClefController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.ClefController.prototype.constructor=Toe.Ctrl.ClefController;Toe.Model.Clef=function(a,b){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");var d=null;"c"==a?d=0:"f"==a&&(d=2);this.props={systemPos:d,interact:!0};$.extend(this.props,b);this.zone={};this.system=null};Toe.Model.Clef.Type={c:"Doh Clef",f:"Fah Clef"};Toe.Model.Clef.prototype=new Toe.Model.Model;Toe.Model.Clef.prototype.constructor=Toe.Model.Clef;Toe.Model.Clef.prototype.setID=function(a){this.id=a};
Toe.Model.Clef.prototype.setSystem=function(a){if(!(a instanceof Toe.Model.System))throw Error("Toe.Model.Clef: invalid system reference");this.system=a};Toe.Model.Clef.prototype.setShape=function(a){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");this.system.updatePitchedElements({clef:this,custos:!1});$(this).trigger("vUpdateShape",[this])};
Toe.Model.Clef.prototype.setSystemPosition=function(a){this.props.systemPos!=a&&(this.props.systemPos=a,this.system.updatePitchedElements({clef:this,custos:!1}),$(this).trigger("vUpdateSystemPosition",[this]))};Toe.Model.Clef.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Clef: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Clef.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.View.ClefView=function(a){this.rendEng=a;this.drawing=null};Toe.View.ClefView.prototype=new Toe.View.View;Toe.View.ClefView.prototype.constructor=Toe.View.ClefView;
Toe.View.ClefView.prototype.drawClef=function(a){if(!this.rendEng)throw Error("Clef: Invalid render context");var b=a.system,d=null;switch(a.shape){case "c":d="c_clef";break;case "f":d="f_clef"}var d=this.rendEng.getGlyph(d),e=a.zone.ulx+d.centre[0],b=b.zone.uly-a.props.systemPos*b.delta_y/2;"f"==a.shape&&(b+=.34*d.centre[1]);b=d.clone().set({left:e,top:b});this.drawing=this.rendEng.draw({fixed:[],modify:[b]},{selectable:a.props.interact,group:!0,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.ClefView.prototype.renderClef=function(a){this.drawClef(a)};Toe.View.ClefView.prototype.renderClefBoundingBox=function(a){this.rendEng.outlineBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry],{fill:"red"})};Toe.View.ClefView.prototype.updateShape=function(a){if(this.drawing)this.rendEng.canvas.remove(this.drawing);else throw Error("Clef: update method called, but there exists no drawing to update.");this.drawClef(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.ClefView.prototype.updateSystemPosition=function(a){if(!this.drawing)throw Error("Clef: update method called, but there exists no drawing to update.");var b=a.system.zone.uly-a.props.systemPos*a.system.delta_y/2;"f"==a.shape&&(b+=.34*this.drawing.currentHeight/2);this.drawing.top=b;this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.ClefView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.View.GUI=function(a,b,d,e){var f={sldr_bgImgOpacity:!0,sldr_glyphOpacity:!0,initGlyphOpacity:1,initBgImgOpacity:.6};$.extend(f,e);this.rendEng=d;this.apiprefix=a;this.meipath=b;this.setupNavBar();this.setupSideBar("#gui-sidebar",f);this.bindHotkeys();this.rendEng.repaint()};Toe.View.GUI.prototype.constructor=Toe.View.GUI;
Toe.View.GUI.prototype.setupNavBar=function(){var a=this;$("#nav_file_dropdown").length&&($("#nav_file_dropdown").append('<li><a id="nav_file_dropdown_revert" href="#">Revert</a></li><li class="divider"></li><li><a id="nav_file_dropdown_getmei" href="#">Get MEI</a></li><li><a id="nav_file_dropdown_getimg" href="#">Get Score Image</a></li>'),$("#nav_file_dropdown_revert").tooltip({animation:!0,placement:"right",title:"Revert the current MEI file to the original version. Warning: this will revert all changes made in the editor.",
delay:100}),$("#nav_file_dropdown_revert").click(function(){$.post(a.apiprefix+"/revert",function(a){window.location.reload()}).error(function(){$("#alert > p").text("Server failed to restore backup MEI file.");$("#alert").animate({opacity:1},100)})}),$("#nav_file_dropdown_getmei").tooltip({animation:!0,placement:"right",title:"View the MEI file of the document being edited.",delay:100}),$("#nav_file_dropdown_getmei").attr("href",a.meipath),$("#nav_file_dropdown_getimg").tooltip({animation:!0,placement:"right",
title:"Download an image of the document being edited.",delay:100}),$("#nav_file_dropdown_getimg").click(function(){fabric.Canvas.supports("toDataURL")?window.open(a.rendEng.canvas.toDataURL("png")):$("#alert > p").text("The browser you are using does not support this feature.")}))};
Toe.View.GUI.prototype.setupSideBar=function(a,b){var d=this;if(b.sldr_bgImgOpacity||b.sldr_glyphOpacity)$(a).prepend('<span id="sidebar-app"><li class="nav-header">Appearance</li>\n</span>'),b.sldr_bgImgOpacity&&($("#sidebar-app").append('<li>\n<label for="sldr_bgImgOpacity"><b>Image Opacity</b>:</label>\n<input id="sldr_bgImgOpacity" style="width: 95%;" type="range" name="bgImgOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initBgImgOpacity+'" />\n</li>'),$("#sldr_bgImgOpacity").bind("change",
function(){d.rendEng.canvas.backgroundImageOpacity=$(this).val();d.rendEng.repaint()})),b.sldr_glyphOpacity&&($("#sidebar-app").append('<li>\n<label for="sldr_glyphOpacity"><b>Glyph Opacity</b>:</label>\n<input id="sldr_glyphOpacity" style="width: 95%;" type="range" name="glyphOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initGlyphOpacity+'" />\n</li>'),$("#sldr_glyphOpacity").bind("change",function(){var a=$(this).val();d.rendEng.canvas.forEachObject(function(b){b.setOpacity(a)});d.rendEng.repaint()}))};
Toe.View.GUI.prototype.bindHotkeys=function(){Mousetrap.bind(["e","Ctrl+e","Command+e"],function(){$("#btn_edit").click();return!1});Mousetrap.bind(["i","Ctrl+i","Command+i"],function(){$("#btn_insert").click();return!1})};Toe.Model.Ornament=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Ornament.Type[this.key];if(void 0==this.type)throw Error("Ornament: undefined ornament type");oForm="episema"==a?"horizontal":"dot"==a?"aug":null;this.props={form:oForm,interact:!1};$.extend(this.props,b)};Toe.Model.Ornament.prototype.constructor=Toe.Model.Ornament;Toe.Model.Ornament.Type={episema:"Episema",dot:"Dot"};Toe.Ctrl.PageController=function(a,b){$(b).bind("mSetDimensions.ui",function(b,e,f){a.setDimensions(e,f)});$(a).bind("vSetDimensions",function(a,e,f){b.setDimensions(e,f)});Toe.Ctrl.Controller.call(this,a,b)};Toe.Ctrl.PageController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.PageController.prototype.constructor=Toe.Ctrl.PageController;Toe.Model.Page=function(){this.systems=[];this.scale=1;this.systemAverageHeight=0;this.id=null};Toe.Model.Page.prototype=new Toe.Model.Model;Toe.Model.Page.prototype.constructor=Toe.Model.Page;Toe.Model.Page.prototype.setID=function(a){this.id=a};Toe.Model.Page.prototype.getID=function(){return this.id};Toe.Model.Page.prototype.setDimensions=function(a,b){this.width=this.scale*a;this.height=this.scale*b};
Toe.Model.Page.prototype.calcDimensions=function(a){var b=0,d=0;$(a).each(function(a,f){var h=parseInt($(f).attr("lrx")),c=parseInt($(f).attr("lry"));h>b&&(b=h);c>d&&(d=c)});return[b,d]};Toe.Model.Page.prototype.setPageScale=function(a){this.scale=a};
Toe.Model.Page.prototype.getClosestSystem=function(a){var b=$.map(this.systems,function(b){var e=Math.abs(a.y-(b.zone.lry-(b.zone.lry-b.zone.uly)/2));a.x<b.zone.ulx?e+=b.zone.ulx-a.x:a.x>b.zone.lrx&&(e+=a.x-b.zone.lrx);return e});sInd=$.inArray(Math.min.apply(Math,b),b);return this.systems[sInd]};Toe.Model.Page.prototype.getNextSystem=function(a){a=$.inArray(a,this.systems);return-1!=a&&a+1<this.systems.length?this.systems[a+1]:null};
Toe.Model.Page.prototype.getPreviousSystem=function(a){a=$.inArray(a,this.systems);return 0<=a-1?this.systems[a-1]:null};
Toe.Model.Page.prototype.addSystem=function(a){if(a.orderNumber>this.systems.length)this.systems.push(a);else{for(var b=a.orderNumber-1;b<this.systems.length;b++)this.systems[b].setOrderNumber(parseInt(this.systems[b].orderNumber,10)+1);this.systems.splice(a.orderNumber-1,0,a)}this.systemAverageHeight*=this.systems.length-1;this.systemAverageHeight+=a.getHeight();this.systemAverageHeight/=this.systems.length;$(a).trigger("vRenderSystem",[a]);return this};
Toe.Model.Page.prototype.removeSystem=function(a){var b=[];if(a.orderNumber==this.systems.length)this.systems.pop();else{for(var d=a.orderNumber;d<this.systems.length;d++)this.systems[d].setOrderNumber(parseInt(this.systems[d].orderNumber,10)-1),b.push(this.systems[d]);this.systems.splice(a.orderNumber-1,1)}0<this.systems.length?(this.systemAverageHeight*=this.systems.length+1,this.systemAverageHeight-=a.getHeight(),this.systemAverageHeight/=this.systems.length):this.systemAverageHeight=0;return b};
Toe.Model.Page.prototype.getWidestSystem=function(){for(var a=-1,b=0;b<this.systems.length;b++)if(-1==a||this.systems[b].getWidth()>this.systems[a].getWidth())a=b;return-1==a?null:this.systems[a]};Toe.Model.Page.prototype.parseBoundingBox=function(a){var b=this,d=parseInt($(a).attr("ulx")),e=parseInt($(a).attr("uly")),f=parseInt($(a).attr("lrx"));a=parseInt($(a).attr("lry"));return $.map([d,e,f,a],function(a){return Math.round(b.scale*a)})};Toe.View.PageView=function(a){this.rendEng=a};Toe.View.PageView.prototype=new Toe.View.View;Toe.View.PageView.prototype.constructor=Toe.View.PageView;Toe.View.PageView.prototype.setDimensions=function(a,b){this.canvas.setDimensions({width:a,height:b})};Toe.Ctrl.SystemController=function(a,b){$(a).bind("vRenderSystem",function(a,e){Toe.debug&&b.renderSystemBoundingBox(e);b.renderSystem(e)});Toe.Ctrl.Controller.call(this,a,b)};Toe.Ctrl.SystemController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.SystemController.prototype.constructor=Toe.Ctrl.SystemController;Toe.Ctrl.SystemController.prototype.modifyDimensions=function(a,b,d,e){this.model.setBoundingBox([d,e,d+a,e+b])};
Toe.Ctrl.SystemController.prototype.modifyZone=function(a,b){this.model.setBoundingBox([a-b/2,this.model.zone.uly,a+b/2,this.model.zone.lry])};Toe.Model.System=function(a,b){if(arguments.length){this.props={numLines:4,interact:!0,group:!0};$.extend(this.props,b);if(!Toe.validBoundingBox(a))throw Error("System: invalid bounding box");this.zone={};this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];1<this.props.numLines&&(this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1));this.systemId=this.orderNumber=this.id=null;this.elements=[]}};Toe.Model.System.prototype=new Toe.Model.Model;
Toe.Model.System.prototype.constructor=Toe.Model.System;Toe.Model.System.prototype.setID=function(a){this.id=a};Toe.Model.System.prototype.setSystemID=function(a){this.systemId=a};Toe.Model.System.prototype.setOrderNumber=function(a){this.orderNumber=a};
Toe.Model.System.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("System: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];1<this.props.numLines&&(this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1))};Toe.Model.System.prototype.sortElements=function(){this.elements.sort(function(a,b){return a.zone.ulx-b.zone.ulx})};
Toe.Model.System.prototype.insertElement=function(a){for(var b=this.elements.length,d=0;d<this.elements.length;d++)if(a.zone.ulx<=this.elements[d].zone.ulx){b=d;break}this.elements.splice(b,0,a);return b};Toe.Model.System.prototype.removeElementByID=function(a){for(var b=this.elements.length-1;0<=b;b--)this.elements[b].id==a&&($(this.elements[b]).trigger("vEraseDrawing"),this.elements.splice(b,1))};
Toe.Model.System.prototype.removeElementByRef=function(a){a=$.inArray(a,this.elements);0<=a&&($(this.elements[a]).trigger("vEraseDrawing"),this.elements.splice(a,1))};Toe.Model.System.prototype.getActingClefByEle=function(a){for(a=$.inArray(a,this.elements);0<=a;a--){var b=this.elements[a];if(b instanceof Toe.Model.Clef)return b}return null};
Toe.Model.System.prototype.getActingClefByCoords=function(a){for(var b=this.elements.length;0<=b;b--){var d=this.elements[b];if(d instanceof Toe.Model.Clef&&a.x>d.zone.lrx)return d}return null};Toe.Model.System.prototype.getPreviousClef=function(a){a=$.inArray(a,this.elements);if(0<a)for(--a;0<=a;a--)if(this.elements[a]instanceof Toe.Model.Clef)return this.elements[a];return null};Toe.Model.System.prototype.getWidth=function(){return this.zone.lrx-this.zone.ulx};
Toe.Model.System.prototype.getHeight=function(){return this.zone.lry-this.zone.uly};Toe.Model.System.prototype.getDistanceFromSystem=function(a){return a.zone.uly>this.zone.uly?a.zone.uly-this.zone.lry:this.zone.uly-a.zone.lry};
Toe.Model.System.prototype.getSystemSnapCoordinates=function(a,b,d,e){var f={ignoreEle:null,x:!0,y:!0};$.extend(f,d);if(f.y){d=this.zone.uly;var h=this.zone.uly+this.delta_y/2,c=(a.y-d)/this.delta_y,q=Math.abs(Math.round(Math.abs(c))-Math.abs(c)),k=(a.y-h)/this.delta_y,m=Math.abs(Math.round(Math.abs(k))-Math.abs(k));Math.min(q,m)==q?a.y=d+Math.round(c)*this.delta_y:a.y=h+Math.round(k)*this.delta_y}if(f.x){d=a.x-b/2;h=a.x+b/2;for(c=0;c<this.elements.length;c++)if(this.elements[c]!=f.ignoreEle&&(q=
this.elements[c].zone.ulx,k=this.elements[c].zone.lrx,!(d>=k))){a.x=d>=q&&d<k||h>=q&&h<k||q>d&&k<h?a.x<q+(k-q)/2?q-b/2:k+b/2:a.x;break}this.elements.length&&this.elements[0]instanceof Toe.Model.Clef&&d<=this.elements[0].zone.lrx?a.x=this.elements[0].zone.lrx+b/2+1:d<=this.zone.ulx&&(a.x=this.zone.ulx+b/2+1);this.custos&&f.ignoreEle!=this.custos&&h>=this.custos.zone.ulx?(a.x=this.custos.zone.ulx-b/2-3,e&&(e.showHeadsUp("The element is moved before the last custos in this system."),window.setTimeout(function(){e.hideHeadsUp()},
3E3))):h>=this.zone.lrx&&(a.x=this.zone.lrx-b/2-3)}return a};Toe.Model.System.prototype.getLooseElements=function(){var a=[];if(this.elements&&0<this.elements.length)for(var b=0;b<this.elements.length;b++)(this.elements[b].zone.lrx<this.zone.ulx||this.elements[b].zone.ulx>this.zone.lrx)&&a.push(this.elements[b]);return a};Toe.View.SystemView=function(a){this.rendEng=a;this.drawing=null};Toe.View.SystemView.prototype=new Toe.View.View;Toe.View.SystemView.prototype.constructor=Toe.View.SystemView;
Toe.View.SystemView.prototype.renderSystem=function(a){if(!this.rendEng)throw Error("Toe.View.SystemView: Invalid render context");for(var b={fixed:[],modify:[]},d=0;d<a.props.numLines;d++){var e=a.zone.uly+d*a.delta_y;b.fixed.push(this.rendEng.createLine([a.zone.ulx,e,a.zone.lrx,e]))}this.drawing=this.rendEng.draw(b,{selectable:a.props.interact,group:a.props.group,eleRef:a,lockMovementX:!0,lockMovementY:!0,hasControls:!0,lockScalingX:!1,lockScalingY:!0,lockRotation:!0,lockUniScaling:!1})};
Toe.View.SystemView.prototype.renderSystemBoundingBox=function(a){this.rendEng.outlineBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry],{fill:"blue"})};function SearchTree(){this.rootNode=null;this.numNodes=0}function SearchTreeNode(a){this.payload=a;this.children={};this.numChildren=0}
SearchTree.prototype={setRootNode:function(a){this.rootNode=a},insert:function(a,b){if(!this.rootNode)if(a.length)this.setRootNode(new SearchTreeNode(null)),this.numNodes++;else{this.setRootNode(new SearchTreeNode(b));this.numNodes++;return}this.rootNode.insert(a,b)},remove:function(a){this.rootNode.remove(a)},destroyTree:function(){this.rootNode=null;this.numNodes=0},search:function(a,b){for(var d=this.rootNode,e=0;e<a.length;e++){var f=a[e];if(f in d.children)d=d.children[f];else return b?{result:d.payload,
prefix:!0}:null}return{result:d.payload,prefix:!1}},dfs:function(a){function b(a,c,d){if(c.payload.typeid==a)return c;var f=null,e;for(e in c.children){if(f)break;d[c.children[e].payload.typeid]={e:e,parent:c.payload.typeid};f=b(a,c.children[e],d)}return f}for(var d={},e=b(a,this.rootNode,d),f=[];a in d;)f.push(d[a].e),a=d[a].parent;d=f.reverse();return{node:e,edges:d}},stringify:function(){return JSON.stringify(this)},populateFromJSON:function(a){a=JSON.parse(a);this.rootNode=a.rootNode;this.numNodes=
a.numNodes}};
SearchTreeNode.prototype={insert:function(a,b){var d=a.splice(0,1);a.length?(d in this.children||(this.children[d]=new SearchTreeNode(null),this.numChildren++),this.children[d].insert(a,b)):d in this.children?this.children[d].payload=b:(this.children[d]=new SearchTreeNode(b),this.numChildren++)},remove:function(a){var b=a.splice(0,1);a.length?b in this.children&&this.children[b].remove(a):b in this.children&&(this.children[b].numChildren?this.children[b].payload=null:(delete this.children[b],this.numChildren--))},
getChildren:function(){var a=[],b;for(b in this.children)a.push(this.children[b]);return a}};Toe.View.Interaction=function(a,b,d,e){this.rendEng=a;this.page=b;this.apiprefix=d};Toe.View.Interaction.prototype.constructor=Toe.View.Interaction;Toe.View.Interaction.prototype.showInfo=function(a){$("#info > p").html(a);$("#info").animate({opacity:1},100)};Toe.View.Interaction.prototype.hideInfo=function(){$("#info").animate({opacity:0},100)};Toe.View.Interaction.prototype.showHeadsUp=function(a){$("#headsUp > p").html(a);$("#headsUp").animate({opacity:1},100)};
Toe.View.Interaction.prototype.hideHeadsUp=function(){$("#headsUp").animate({opacity:0},100)};Toe.View.Interaction.prototype.showAlert=function(a){$("#alert > p").text(a);$("#alert").animate({opacity:1},100)};Toe.View.Interaction.prototype.deactivateCanvasObjects=function(){this.rendEng.canvas.selection=!1;this.rendEng.canvas.deactivateAll();this.rendEng.canvas.HOVER_CURSOR=null};
Toe.View.Interaction.prototype.activateCanvasObjects=function(){this.rendEng.canvas.selection=!0;this.rendEng.canvas.HOVER_CURSOR="pointer"};Toe.View.Interaction.prototype.removeInsertControls=function(){$("#sidebar-insert").remove()};Toe.View.Interaction.prototype.removeEditControls=function(){$("#sidebar-edit").remove()};
Toe.View.Interaction.prototype.unbindEventHandlers=function(){this.rendEng.unObserve("mouse:down");this.rendEng.unObserve("mouse:up");this.rendEng.unObserve("mouse:move");this.rendEng.unObserve("object:moving");this.rendEng.unObserve("object:selected");this.rendEng.unObserve("selection:cleared");this.rendEng.unObserve("selection:created");this.rendEng.unObserve("object:modified")};Toe.Model.NeumeComponent=function(a){this.props={type:"punctum",ornaments:[],interact:!0};$.extend(this.props,a)};Toe.Model.NeumeComponent.prototype=new Toe.Model.Model;Toe.Model.NeumeComponent.prototype.constructor=Toe.Model.NeumeComponent;Toe.Model.NeumeComponent.Type={punctum:"Punctum",virga:"Virga",cavum:"Cavum",punctum_inclinatum:"Punctum Inclinatum",punctum_inclinatum_parvum:"Punctum Inclinatum Parva",quilisma:"Quilisma",tractulus:"Tractulus",gravis:"Gravis",oriscus:"Oriscus",stropha:"Stropha"};
Toe.Model.NeumeComponent.prototype.hasOrnament=function(a){return $.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()}).length};Toe.Model.NeumeComponent.prototype.addOrnament=function(a){if(!(a instanceof Toe.Model.Ornament))throw Error("NeumeComponent: Invalid ornament");this.hasOrnament(a.key)||this.props.ornaments.push(a)};Toe.Model.NeumeComponent.prototype.removeOrnament=function(a){this.props.ornaments=$.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()},!0)};Toe.Ctrl.NeumeController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,e){var f=e.left-e.currentWidth/2,h=e.top-e.currentHeight/2;a.setBoundingBox([f,h,f+e.currentWidth,h+e.currentHeight])});$(a).bind("vRenderNeume",function(a,e){e.typeid||e.deriveName();Toe.debug&&b.renderBoundingBox(e);b.render(e)});$(a).bind("vUpdateDrawing",function(a,e){b.updateDrawing(e)});$(a).bind("vEraseDrawing",function(a){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()});Toe.Ctrl.Controller.call(this,
a,b)};Toe.Ctrl.NeumeController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.NeumeController.prototype.constructor=Toe.Ctrl.NeumeController;Toe.Model.Neume=function(a){this.zone={};this.props={modifier:null,interact:!0};$.extend(this.props,a);this.props.modifier=Toe.Model.Neume.Modifier[this.props.modifier];void 0==this.props.modifier&&(this.props.modifier=null);this.system=this.id=this.neumePrefix=this.typeid=this.name=null;this.components=[]};Toe.Model.Neume.prototype=new Toe.Model.Model;Toe.Model.Neume.prototype.constructor=Toe.Model.Neume;Toe.Model.Neume.Modifier={alt:"liquescence",aug:"liquescence_aug",dim:"liquescence_dim"};
Toe.Model.Neume.prototype.setID=function(a){this.id=a};Toe.Model.Neume.prototype.setSystem=function(a){if(!(a instanceof Toe.Model.System))throw Error("Toe.Model.Neume: invalid system reference");this.system=a};Toe.Model.Neume.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Neume: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Neume.prototype.addComponent=function(a,b){opts={ncInd:this.components.length};$.extend(opts,b);this.components.splice(opts.ncInd,0,a)};Toe.Model.Neume.prototype.syncDrawing=function(){this.deriveName();$(this).trigger("vUpdateDrawing",[this])};Toe.View.NeumeView=function(a,b){this.rendEng=a;switch(b){case "liber":Toe.View.NeumeView.prototype.drawNeume=drawLiberNeume;break;case "salzinnes":Toe.View.NeumeView.prototype.drawNeume=drawSalzinnesNeume;break;case "stgallen":Toe.View.NeumeView.prototype.drawNeume=drawHartkerNeume;break;default:throw"Invalid Drawing Library";}this.ledgerLines=this.drawing=null};Toe.View.NeumeView.prototype=new Toe.View.View;Toe.View.NeumeView.prototype.constructor=Toe.View.NeumeView;
Toe.View.NeumeView.prototype.calcNoteYPos=function(a){var b=a.system,d=[];d.push(b.zone.uly-a.rootSystemPos*b.delta_y/2);for(var e=1;e<a.components.length;e++)d.push(d[0]+-a.components[e].pitchDiff*b.delta_y/2);return d};
Toe.View.NeumeView.prototype.bestDotPlacements=function(a,b,d){var e=[],f=a.zone.uly+a.delta_y/2,h=ypos=b[d],c=Math.round(2*(h-f)/a.delta_y);0==c%2&&e.push(h);var q=ypos-a.delta_y/2,c=Math.round(2*(q-f)/a.delta_y),h=!1;if(0<=d-1&&ypos-a.delta_y/2==b[d-1]||d+1<b.length&&ypos-a.delta_y/2==b[d+1])h=!0;0!=c%2||h||e.push(q);q=ypos+a.delta_y/2;c=Math.round(2*(q-f)/a.delta_y);h=!1;if(d+1<b.length&&ypos+a.delta_y/2==b[d+1]||0<=d-1&&ypos+a.delta_y/2==b[d-1])h=!0;0!=c%2||h||e.push(q);return e};
Toe.View.NeumeView.prototype.drawLedgerLines=function(a,b,d,e){d*=.75;var f=this,h=[],c=2*(1-e.props.numLines);$.each(a,function(a,k){if(0<k)for(var m=0;m<=k;m+=2){var l=e.zone.uly-m*e.delta_y/2;h.push(f.rendEng.createLine([b[a]-d,l,b[a]+d,l]))}else if(k<c)for(m=c;m>=k;m-=2)l=e.zone.uly-m*e.delta_y/2,h.push(f.rendEng.createLine([b[a]-d,l,b[a]+d,l]))});this.ledgerLines=this.rendEng.draw({fixed:h,modify:[]},{group:!0,selectable:!1})[0]};Toe.View.NeumeView.prototype.render=function(a){this.drawNeume(a)};
Toe.View.NeumeView.prototype.renderBoundingBox=function(a){this.rendEng.outlineBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry],{fill:"green"})};Toe.View.NeumeView.prototype.updateDrawing=function(a){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.drawNeume(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.NeumeView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.NeumeView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Ctrl.CustosController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,e){var f=e.left-e.currentWidth/2,h=e.top-e.currentHeight/2;a.setBoundingBox([f,h,f+e.currentWidth,h+e.currentHeight])});$(a).bind("vRenderCustos",function(a,e){Toe.debug&&b.renderBoundingBox(e);b.renderCustos(e)});$(a).bind("vUpdateSystemPosition",function(a,e){b.updateSystemPosition(e)});$(a).bind("vEraseDrawing",function(a){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()});Toe.Ctrl.Controller.call(this,
a,b)};Toe.Ctrl.CustosController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.CustosController.prototype.constructor=Toe.Ctrl.CustosController;Toe.Model.Custos=function(a,b,d){this.props={interact:!0};$.extend(this.props,d);this.pname=a;this.oct=b;this.rootSystemPos=null;this.zone={};this.system=this.id=null};Toe.Model.Custos.prototype=new Toe.Model.Model;Toe.Model.Custos.prototype.constructor=Toe.Model.Custos;Toe.Model.Custos.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Custos.prototype.setID=function(a){this.id=a};Toe.Model.Custos.prototype.setSystem=function(a){if(!(a instanceof Toe.Model.System))throw Error("Toe.Model.Custos: invalid aSystem reference");this.system=a};Toe.Model.Custos.prototype.setRootNote=function(a,b){this.pname=a;this.oct=b};
Toe.Model.Custos.prototype.setRootSystemPos=function(a){this.rootSystemPos!=a&&(this.rootSystemPos=a,a=this.system.getActingClefByEle(this),a=this.system.calcPitchFromSystemPos(this.rootSystemPos,a),this.setRootNote(a.pname,a.oct),$(this).trigger("vUpdateSystemPosition",[this]))};Toe.Model.Custos.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Model.Custos.prototype.eraseDrawing=function(){$(this).trigger("vEraseDrawing")};Toe.View.CustosView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.CustosView.prototype=new Toe.View.View;Toe.View.CustosView.prototype.constructor=Toe.View.CustosView;
Toe.View.CustosView.prototype.drawLedgerLines=function(a,b,d,e){d*=.75;var f=[],h=2*(1-e.props.numLines);if(0<a)for(h=0;h<=a;h+=2){var c=e.zone.uly-h*e.delta_y/2;f.push(this.rendEng.createLine([b-d,c,b+d,c]))}else if(a<h)for(;h>=a;h-=2)c=e.zone.uly-h*e.delta_y/2,f.push(this.rendEng.createLine([b-d,c,b+d,c]));this.ledgerLines=this.rendEng.draw({fixed:f,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.CustosView.prototype.renderCustos=function(a){if(!this.rendEng)throw Error("Custos: Invalid render context");var b=a.system,d=this.rendEng.getGlyph("custos"),e=b.zone.uly-a.rootSystemPos*b.delta_y/2,f=a.zone.ulx+d.centre[0],e=d.clone().set({left:f,top:e-d.centre[1]/2});this.drawLedgerLines(a.rootSystemPos,f,4*d.centre[0],b);this.drawing=this.rendEng.draw({fixed:[],modify:[e]},{selectable:a.props.interact,group:!0,lockMovementX:!0,lockMovementY:!0,eleRef:a})[0]};
Toe.View.CustosView.prototype.renderBoundingBox=function(a){this.rendEng.outlineBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry],{fill:"purple"})};
Toe.View.CustosView.prototype.updateSystemPosition=function(a){if(!this.drawing)throw Error("Custos: update method called, but there exists no drawing to update.");this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);var b=a.system;this.drawing.top=b.zone.uly-a.rootSystemPos*b.delta_y/2-this.drawing.currentHeight/4;this.drawLedgerLines(a.rootSystemPos,this.drawing.left,1.5*this.drawing.currentWidth,b);this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.CustosView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.CustosView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Ctrl.DivisionController=function(a,b){$(a).bind("vRenderDivision",function(a,e){Toe.debug&&b.renderBoundingBox(e);b.renderDivision(e)});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()});Toe.Ctrl.Controller.call(this,a,b)};Toe.Ctrl.DivisionController.prototype=new Toe.Ctrl.Controller;Toe.Ctrl.DivisionController.prototype.constructor=Toe.Ctrl.DivisionController;Toe.Model.Division=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Division.Type[this.key];if(void 0==this.type)throw Error("Division: undefined division type");this.props={interact:!0};$.extend(this.props,b);this.zone={};this.system=this.id=null};Toe.Model.Division.prototype=new Toe.Model.Model;Toe.Model.Division.prototype.constructor=Toe.Model.Division;
Toe.Model.Division.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Division.prototype.setID=function(a){this.id=a};Toe.Model.Division.prototype.setSystem=function(a){if(!(a instanceof Toe.Model.System))throw Error("Toe.Model.Division: invalid system reference");this.system=a};
Toe.Model.Division.Type={div_small:"Small Division",div_minor:"Minor Division",div_major:"Major Division",div_final:"Final Division"};Toe.Model.Division.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.View.DivisionView=function(a){this.rendEng=a};Toe.View.DivisionView.prototype=new Toe.View.View;Toe.View.DivisionView.prototype.constructor=Toe.View.DivisionView;
Toe.View.DivisionView.prototype.renderDivision=function(a){if(!this.rendEng)throw Error("Division: Invalid render context");var b=a.system,d={fixed:[],modify:[]},e=a.zone.ulx,f={strokeWidth:4};switch(a.type){case Toe.Model.Division.Type.div_small:var h=b.zone.uly-b.delta_y/2,b=b.zone.uly+b.delta_y/2;d.fixed.push(this.rendEng.createLine([e,h,e,b],f));break;case Toe.Model.Division.Type.div_minor:h=b.zone.uly+b.delta_y/2;b=h+2*b.delta_y;d.fixed.push(this.rendEng.createLine([e,h,e,b],f));break;case Toe.Model.Division.Type.div_major:h=
b.zone.uly;b=b.zone.lry;d.fixed.push(this.rendEng.createLine([e,h,e,b],f));break;case Toe.Model.Division.Type.div_final:h=b.zone.uly,b=b.zone.lry,d.fixed.push(this.rendEng.createLine([e,h,e,b],f)),e=a.zone.lrx,d.fixed.push(this.rendEng.createLine([e,h,e,b],f))}this.drawing=this.rendEng.draw(d,{group:!0,selectable:a.props.interact,eleRef:a})[0]};Toe.View.DivisionView.prototype.renderBoundingBox=function(a){this.rendEng.outlineBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry],{fill:"yellow"})};
Toe.View.DivisionView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};var drawLiberNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);for(var b=this.calcNoteYPos(a),d=a.system,e=this,f=[],h=0;h<a.components.length;h++){var c=null;switch(a.components[h].props.name){case Toe.Model.NeumeComponent.Type.punctum:c="punctum";break;case Toe.Model.NeumeComponent.Type.virga:c="punctum";break;case Toe.Model.NeumeComponent.Type.cavum:c="whitepunct";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum:c=
"diamond";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum_parvum:c="diamond_small";break;case Toe.Model.NeumeComponent.Type.quilisma:c="quilisma"}f.push(this.rendEng.getGlyph(c))}var q=this.rendEng.getGlyph("dot"),k={fixed:[],modify:[]};switch(a.typeid){case "punctum":case "cavum":var c=a.zone.ulx+f[0].centre[0],m=f[0].clone().set({left:c,top:b[0]});k.modify.push(m);if(a.components[0].hasOrnament("dot")){var l=this.bestDotPlacements(d,b,0);k.modify.push(q.clone().set({left:m.left+2*f[0].centre[0],
top:l[0]}))}this.drawLedgerLines([a.rootSystemPos],[c],2*f[0].centre[0],d);break;case "distropha":case "tristropha":var g=[];g.push(a.zone.ulx+f[0].centre[0]);for(var p=0;p<a.components.length;p++)m=f[p].clone().set({left:g[p],top:b[p]}),k.modify.push(m),g.push(g[p]+3*f[p].centre[0]);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var f=e.bestDotPlacements(d,b,a);0<f.length&&k.modify.push(q.clone().set({left:g[g.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d);break;case "virga":c=a.zone.ulx+f[0].centre[0];m=f[0].clone().set({left:c,top:b[0]});k.modify.push(m);a.components[0].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,0),k.modify.push(q.clone().set({left:m.left+2*f[0].centre[0],top:l[0]})));var n=m.left+f[0].centre[0]-1,n=this.rendEng.createLine([n,b[0],n,b[0]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(n);this.drawLedgerLines([a.rootSystemPos],[c],2*f[0].centre[0],d);break;case "bivirga":case "trivirga":g=
[];g.push(a.zone.ulx+f[0].centre[0]);for(p=0;p<a.components.length;p++)m=f[p].clone().set({left:g[p],top:b[p]}),k.modify.push(m),n=m.left+f[p].centre[0]-1,n=this.rendEng.createLine([n,b[p],n,b[p]+1.5*d.delta_y],{strokeWidth:2,interact:!0}),k.fixed.push(n),g.push(g[p]+3*f[p].centre[0]);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var f=e.bestDotPlacements(d,b,a);0<f.length&&k.modify.push(q.clone().set({left:g[g.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d);break;case "clivis":g=[];g.push(a.zone.ulx+f[0].centre[0]);var r=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(r);n=g[0]-f[0].centre[0]+1;n=this.rendEng.createLine([n,b[0],n,a.zone.lry],{strokeWidth:2,interact:!0});k.fixed.push(n);n=r.left+f[0].centre[0]-1;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);g.push(g[0]+2*f[1].centre[0]);var u=f[1].clone().set({left:g[1],top:b[1]});k.modify.push(u);$.each(a.components,function(a,
c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:u.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "cephalicus":g=[];c=this.rendEng.getGlyph("cephalicus");g.push(a.zone.ulx+c.centre[0]);r=c.clone().set({left:g[0],top:b[0]-c.centre[1]/2});k.modify.push(r);n=g[0]-c.centre[0]+1;n=this.rendEng.createLine([n,b[0],n,a.zone.lry],{strokeWidth:2,
interact:!0});k.fixed.push(n);n=r.left+c.centre[0]-2;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);p=this.rendEng.getGlyph("liques_up");g.push(g[0]+c.centre[0]-p.centre[0]);u=p.clone().set({left:g[1],top:b[1]-p.centre[1]/2});k.modify.push(u);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:u.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d);break;case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":case "climacus.resupinus.1":case "climacus.resupinus.2":case "climacus.resupinus.3":case "climacus.resupinus.4":g=[];g.push(a.zone.ulx+f[0].centre[0]);p=f[0].centre[0];m=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(m);n=m.left+f[0].centre[0]-1;n=this.rendEng.createLine([n,b[0],n,b[0]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(n);for(c=1;c<a.components.length;c++)g.push(g[c-
1]+2*f[c-1].centre[0]-1),1==c&&(g[1]+=p),n=f[c].clone().set({left:g[c],top:b[c]}),k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&k.modify.push(q.clone().set({left:g[a]+2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "torculus":g=[];g.push(a.zone.ulx+f[0].centre[0]);g.push(g[0]+2*f[0].centre[0]-1);g.push(g[1]+2*f[1].centre[0]-
1);r=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(r);n=r.left+f[0].centre[0]-1;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);u=f[1].clone().set({left:g[1],top:b[1]});k.modify.push(u);n=u.left+f[1].centre[0]-1;n=this.rendEng.createLine([n,b[1],n,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(n);c=f[2].clone().set({left:g[2],top:b[2]});k.modify.push(c);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&
k.modify.push(q.clone().set({left:g[a]+2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "torculus.resupinus.1":case "torculus.resupinus.2":case "torculus.resupinus.3":case "torculus.resupinus.4":g=[];g.push(a.zone.ulx+f[0].centre[0]);r=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(r);var c=this.rendEng.getGlyph("porrect_1"),t=c.clone().set({left:g[0]+f[0].centre[0]+c.centre[0]-1,top:b[1]+
c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0];m=b[0];l=t.top+c.centre[1];n=this.rendEng.createLine([n,b[1],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);"torculus.resupinus.1"==a.typeid?g.push(t.left+c.centre[0]-f[3].centre[0]):g.push(t.left+c.centre[0]+f[3].centre[0]);m=f[3].clone().set({left:g[1],top:b[3]});k.modify.push(m);n=t.left+c.centre[0]-1;n=this.rendEng.createLine([n,b[3],n,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(n);"torculus.resupinus.2"==a.typeid&&(n=m.left+f[3].centre[0]-
1,n=this.rendEng.createLine([n,b[4],n,b[3]],{strokeWidth:2,interact:!0}),k.fixed.push(n));for(c=4;c<a.components.length;c++)g.push(g[g.length-1]+2*f[c].centre[0]-1),n=f[c].clone().set({left:g[g.length-1],top:b[c]}),k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&k.modify.push(q.clone().set({left:g[a]+2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],
d);break;case "podatus":g=[];p=0;1==Math.abs(a.components[1].pitchDiff)&&(p=1);c=this.rendEng.getGlyph("pes");g.push(a.zone.ulx+c.centre[0]);r=c.clone().set({left:g[0],top:b[0]-c.centre[1]/2+p});k.modify.push(r);n=r.left+c.centre[0]-1;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);g.push(g[0]);u=f[1].clone().set({left:g[1],top:b[1]-p});k.modify.push(u);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:r.left+
2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "podatus.subpunctis.1":case "podatus.subpunctis.2":case "podatus.subpunctis.3":case "podatus.subpunctis.4":case "podatus.subpunctis.resupinus.1":case "podatus.subpunctis.resupinus.2":case "podatus.subpunctis.resupinus.3":g=[];p=0;1==Math.abs(a.components[1].pitchDiff)&&(p=1);m=f[0].centre[0];c=this.rendEng.getGlyph("pes");g.push(a.zone.ulx+c.centre[0]);
r=c.clone().set({left:g[0],top:b[0]-c.centre[1]/2+p});k.modify.push(r);n=r.left+c.centre[0]-1;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);g.push(g[0]);u=f[1].clone().set({left:g[1],top:b[1]-p});k.modify.push(u);for(c=2;c<a.components.length;c++)g.push(g[c-1]+2*f[c-1].centre[0]-1),2==c&&(g[c]+=m),n=f[c].clone().set({left:g[c],top:b[c]}),k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&
k.modify.push(q.clone().set({left:g[a]+2*f[a].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "epiphonus":g=[];c=this.rendEng.getGlyph("podatus_ep");g.push(a.zone.ulx+c.centre[0]);r=c.clone().set({left:g[0],top:b[0]});k.modify.push(r);n=r.left+c.centre[0]-2;n=this.rendEng.createLine([n,b[0],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);p=this.rendEng.getGlyph("liques_down");g.push(g[0]+c.centre[0]-
p.centre[0]);u=p.clone().set({left:g[1],top:b[1]+p.centre[1]/2});k.modify.push(u);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:r.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "porrectus":n=a.components[0].pitchDiff+a.components[1].pitchDiff;c=null;switch(n){case -1:c=this.rendEng.getGlyph("porrect_1");
break;case -2:c=this.rendEng.getGlyph("porrect_2");break;case -3:c=this.rendEng.getGlyph("porrect_3");break;case -4:c=this.rendEng.getGlyph("porrect_4");break;default:c=this.rendEng.getGlyph("porrect_4")}t=c.clone().set({left:a.zone.ulx+c.centre[0],top:b[0]+c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0]+1;m=a.zone.lry;l=t.top+c.centre[1];a.zone.lry<t.top+l&&(m=l);n=this.rendEng.createLine([n,b[0],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);g=t.left+c.centre[0]-f[2].centre[0];m=f[2].clone().set({left:g,
top:b[2]});n=m.left+f[2].centre[0]-1;n=this.rendEng.createLine([n,b[2],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);k.modify.push(m);a.components[2].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,2),0<l.length&&k.modify.push(q.clone().set({left:m.left+2*f[2].centre[0],top:l[0]})));this.drawLedgerLines([a.rootSystemPos+a.components[2].pitchDiff],[g],2*f[2].centre[0],d);break;case "porrectus.flexus":c=null;n=a.components[0].pitchDiff+a.components[1].pitchDiff;switch(n){case -1:c=this.rendEng.getGlyph("porrect_1");
break;case -2:c=this.rendEng.getGlyph("porrect_2");break;case -3:c=this.rendEng.getGlyph("porrect_3");break;case -4:c=this.rendEng.getGlyph("porrect_4");break;default:c=this.rendEng.getGlyph("porrect_4")}t=c.clone().set({left:a.zone.ulx+c.centre[0],top:b[0]+c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0]+1;m=a.zone.lry;l=t.top+c.centre[1];a.zone.lry<t.top+l&&(m=l);n=this.rendEng.createLine([n,b[0],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);g=[];g.push(t.left+c.centre[0]+f[2].centre[0]);
m=f[2].clone().set({left:g[0],top:b[2]});n=g[0]-f[2].centre[0]-1;n=this.rendEng.createLine([n,b[2],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);k.modify.push(m);for(c=3;c<a.components.length;c++)g.push(g[g.length-1]+2*f[c].centre[0]-1),n=f[c].clone().set({left:g[g.length-1],top:b[c]}),k.modify.push(n);for(c=2;c<a.components.length;c++)n=a.components[c],n.hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,p),0<l.length&&k.modify.push(q.clone().set({left:r.left+2*f[1].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,
function(b,c){if(2<=c)return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "porrectus.subpunctis.1":case "porrectus.subpunctis.2":case "porrectus.subpunctis.resupinus.1":case "porrectus.subpunctis.resupinus.2":n=a.components[0].pitchDiff+a.components[1].pitchDiff;c=null;switch(n){case -1:c=this.rendEng.getGlyph("porrect_1");break;case -2:c=this.rendEng.getGlyph("porrect_2");break;case -3:c=this.rendEng.getGlyph("porrect_3");break;case -4:c=this.rendEng.getGlyph("porrect_4");break;
default:c=this.rendEng.getGlyph("porrect_4")}t=c.clone().set({left:a.zone.ulx+c.centre[0],top:b[0]+c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0]+1;m=a.zone.lry;l=t.top+c.centre[1];a.zone.lry<t.top+l&&(m=l);n=this.rendEng.createLine([n,b[0],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);g=[];g.push(t.left+c.centre[0]-f[2].centre[0]);m=f[2].clone().set({left:g[0],top:b[2]});n=g[0]+f[2].centre[0]-1;n=this.rendEng.createLine([n,b[2],n,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(n);k.modify.push(m);
g.push(t.left+c.centre[0]+2*f[2].centre[0]);for(c=3;c<a.components.length;c++)n=f[c].clone().set({left:g[c-2],top:b[c]}),k.modify.push(n),c+1<a.components.length&&g.push(g[c-2]+2*f[c].centre[0]-1);for(c=2;c<a.components.length;c++)n=a.components[c],n.hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,c),0<l.length&&k.modify.push(q.clone().set({left:g[c-2]+2*f[c].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b,c){if(2<=c)return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],
d);break;case "compound.1":c=null;n=a.components[0].pitchDiff+a.components[1].pitchDiff;switch(n){case -1:c=this.rendEng.getGlyph("porrect_1");break;case -2:c=this.rendEng.getGlyph("porrect_2");break;case -3:c=this.rendEng.getGlyph("porrect_3");break;case -4:c=this.rendEng.getGlyph("porrect_4");break;default:c=this.rendEng.getGlyph("porrect_4")}t=c.clone().set({left:a.zone.ulx+c.centre[0],top:b[0]+c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0]+1;m=a.zone.lry;l=t.top+c.centre[1];a.zone.lry<
t.top+l&&(m=l);n=this.rendEng.createLine([n,b[0],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);g=[];g.push(t.left+c.centre[0]+f[2].centre[0]);for(c=2;c<a.components.length;c++)n=f[c].clone().set({left:g[c-2],top:b[c]}),k.modify.push(n),n=g[c-2]-f[2].centre[0]-1,n=this.rendEng.createLine([n,b[c],n,b[c-1]],{strokeWidth:2,interact:!0}),k.fixed.push(n),c+1<a.components.length&&g.push(g[c-2]+2*f[c].centre[0]-1);for(c=2;c<a.components.length;c++)n=a.components[c],n.hasOrnament("dot")&&(l=e.bestDotPlacements(d,
b,c),0<l.length&&k.modify.push(q.clone().set({left:g[c-2]+2*f[c].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b,c){if(2<=c)return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "compound.2":c=null;n=a.components[0].pitchDiff+a.components[1].pitchDiff;switch(n){case -1:c=this.rendEng.getGlyph("porrect_1");break;case -2:c=this.rendEng.getGlyph("porrect_2");break;case -3:c=this.rendEng.getGlyph("porrect_3");break;case -4:c=this.rendEng.getGlyph("porrect_4");
break;default:c=this.rendEng.getGlyph("porrect_4")}t=c.clone().set({left:a.zone.ulx+c.centre[0],top:b[0]+c.centre[1]/2});k.modify.push(t);n=t.left-c.centre[0]+1;m=a.zone.lry;l=t.top+c.centre[1];a.zone.lry<t.top+l&&(m=l);n=this.rendEng.createLine([n,b[0],n,m],{strokeWidth:2,interact:!0});k.fixed.push(n);g=[];g.push(t.left+c.centre[0]+f[2].centre[0]);m=this.rendEng.getGlyph("pes");p=0;1==Math.abs(a.components[3].pitchDiff-a.components[2].pitchDiff)&&(p=1);n=g[0]-f[2].centre[0];n=this.rendEng.createLine([n,
b[1],n,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(n);l=m.clone().set({left:g[0],top:b[2]-m.centre[1]/2+p});k.modify.push(l);l=g[0]+m.centre[0]-1;l=this.rendEng.createLine([l,b[2],l,b[3]],{strokeWidth:2,interact:!0});k.fixed.push(l);g.push(g[0]);u=f[3].clone().set({left:g[1],top:b[3]-p});k.modify.push(u);for(c=2;c<a.components.length;c++)n=a.components[c],n.hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,c),0<l.length&&k.modify.push(q.clone().set({left:g[c-2]+2*f[c].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,
function(b,c){if(2<=c)return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.1":case "scandicus.2":case "scandicus.3":case "scandicus.4":n=a.components.length;m=this.rendEng.getGlyph("pes");t=a.zone.ulx-f[0].centre[0];g=[];for(c=0;c<n-1;c+=2)for(p=0,1==Math.abs(a.components[c+1].pitchDiff-a.components[c].pitchDiff)&&(p=1),t+=2*m.centre[0]-1,g.push(t),l=m.clone().set({left:t,top:b[c]-m.centre[1]/2+p}),k.modify.push(l),l=t+m.centre[0]-1,l=this.rendEng.createLine([l,b[c],l,
b[c+1]],{strokeWidth:2,interact:!0}),k.fixed.push(l),g.push(t),u=f[c+1].clone().set({left:t,top:b[c+1]-p}),k.modify.push(u),h=c;h<c+2;h++)a.components[h].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,h),0<l.length&&k.modify.push(q.clone().set({left:u.left+2*f[h].centre[0],top:l[0]})));1==a.components.length%2&&(t+=2*f[n-1].centre[0]-1,g.push(t),c=f[n-1].clone().set({left:t,top:b[n-1]}),k.modify.push(c),a.components[n-1].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,n-1),0<l.length&&k.modify.push(q.clone().set({left:c.left+
2*f[n-1].centre[0],top:l[0]}))),c=t+f[n-1].centre[0]-2,c=this.rendEng.createLine([c,b[n-1],c,a.zone.lry-(a.zone.lry-a.zone.uly)/2],{strokeWidth:2,interact:!0}),k.fixed.push(c));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.flexus.1":m=this.rendEng.getGlyph("pes");g=[];g.push(a.zone.ulx+m.centre[0]);p=0;1==Math.abs(a.components[1].pitchDiff-a.components[0].pitchDiff)&&(p=1);l=m.clone().set({left:g[0],top:b[0]-m.centre[1]/
2+p});k.modify.push(l);l=g[0]+m.centre[0]-1;l=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(l);g.push(g[0]);u=f[1].clone().set({left:g[1],top:b[1]-p});k.modify.push(u);g.push(g[1]+3*f[2].centre[0]);c=f[2].clone().set({left:g[2],top:b[2]});k.modify.push(c);n=g[2]-f[2].centre[0]+1;n=this.rendEng.createLine([n,b[2],n,b[2]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(n);n=g[2]+f[2].centre[0]-1;n=this.rendEng.createLine([n,b[2],n,b[3]],{strokeWidth:2,interact:!0});
k.fixed.push(n);g.push(g[2]+2*f[3].centre[0]);c=f[3].clone().set({left:g[3],top:b[3]});k.modify.push(c);for(h=2;h<a.components.length;h++)a.components[h].hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,h),0<l.length&&k.modify.push(q.clone().set({left:g[h]+2*f[h].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.flexus.2":m=this.rendEng.getGlyph("pes");g=[];g.push(a.zone.ulx+m.centre[0]);p=0;1==
Math.abs(a.components[1].pitchDiff-a.components[0].pitchDiff)&&(p=1);l=m.clone().set({left:g[0],top:b[0]-m.centre[1]/2+p});k.modify.push(l);l=g[0]+m.centre[0]-1;l=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(l);g.push(g[0]);u=f[1].clone().set({left:g[1],top:b[1]-p});k.modify.push(u);for(c=2;c<a.components.length;c++)g.push(g[c-1]+2*f[c-1].centre[0]-1),m=f[c].clone().set({left:g[c],top:b[c]}),k.modify.push(m),c+1<a.components.length&&(n=g[c]+f[c].centre[0]-1,n=
this.rendEng.createLine([n,b[c],n,b[c+1]],{strokeWidth:2,interact:!0}),k.fixed.push(n));for(p=0;p<a.components.length;p++)a.components[p].hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,p),0<l.length&&k.modify.push(q.clone().set({left:g[p]+2*f[1].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.flexus.3":g=[];g.push(a.zone.ulx+f[0].centre[0]);r=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(r);
p=0;1==Math.abs(a.components[2].pitchDiff-a.components[1].pitchDiff)&&(p=1);m=this.rendEng.getGlyph("pes");g.push(g[0]+2*f[0].centre[0]-1);l=m.clone().set({left:g[1],top:b[1]-m.centre[1]/2+p});k.modify.push(l);l=g[1]+m.centre[0]-1;l=this.rendEng.createLine([l,b[1],l,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(l);g.push(g[1]);c=f[2].clone().set({left:g[2],top:b[2]-p});k.modify.push(c);for(c=3;c<a.components.length;c++)g.push(g[c-1]+2*f[c-1].centre[0]-1),m=f[c].clone().set({left:g[c],top:b[c]}),
k.modify.push(m),c+1<a.components.length&&(n=g[c]+f[c].centre[0]-1,n=this.rendEng.createLine([n,b[c],n,b[c+1]],{strokeWidth:2,interact:!0}),k.fixed.push(n));for(p=0;p<a.components.length;p++)a.components[p].hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,p),0<l.length&&k.modify.push(q.clone().set({left:g[p]+2*f[p].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.subpunctis.1":case "scandicus.subpunctis.2":m=
this.rendEng.getGlyph("pes");g=[];g.push(a.zone.ulx+m.centre[0]);p=0;1==Math.abs(a.components[1].pitchDiff-a.components[0].pitchDiff)&&(p=1);l=m.clone().set({left:g[0],top:b[0]-m.centre[1]/2+p});k.modify.push(l);l=g[0]+m.centre[0]-1;l=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(l);g.push(g[0]);u=f[1].clone().set({left:g[1],top:b[1]-p});k.modify.push(u);g.push(g[1]+2*f[2].centre[0]);c=f[2].clone().set({left:g[2],top:b[2]});k.modify.push(c);n=g[2]+f[2].centre[0]-
1;n=this.rendEng.createLine([n,b[2],n,b[2]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(n);p=f[2].centre[0];for(c=3;c<a.components.length;c++)g.push(g[c-1]+2*f[c-1].centre[0]-1),3==c&&(g[c]+=p),n=f[c].clone().set({left:g[c],top:b[c]}),k.modify.push(n);for(p=0;p<a.components.length;p++)a.components[p].hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,p),0<l.length&&k.modify.push(q.clone().set({left:g[p]+2*f[p].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d)}this.drawing=this.rendEng.draw(k,{group:!0,selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};var drawSalzinnesNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);for(var b=this.calcNoteYPos(a),d=a.system,e=this,f=[],h=0;h<a.components.length;h++){var c=null;switch(a.components[h].props.name){case Toe.Model.NeumeComponent.Type.punctum:c="punctum";break;case Toe.Model.NeumeComponent.Type.virga:c="punctum";break;case Toe.Model.NeumeComponent.Type.cavum:c="whitepunct";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum:c=
"diamond";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum_parvum:c="diamond_small";break;case Toe.Model.NeumeComponent.Type.quilisma:c="quilisma"}f.push(this.rendEng.getGlyph(c))}var q=this.rendEng.getGlyph("dot"),k={fixed:[],modify:[]};switch(a.typeid){case "punctum":case "cavum":var m=a.zone.ulx+f[0].centre[0],c=f[0].clone().set({left:m,top:b[0]});k.modify.push(c);if(a.components[0].hasOrnament("dot")){var l=this.bestDotPlacements(d,b,0);k.modify.push(q.clone().set({left:c.left+2*f[0].centre[0],
top:l[0]}))}this.drawLedgerLines([a.rootSystemPos],[m],2*f[0].centre[0],d);break;case "distropha":case "tristropha":var g=[];g.push(a.zone.ulx+f[0].centre[0]);for(m=0;m<a.components.length;m++)c=f[m].clone().set({left:g[m],top:b[m]}),k.modify.push(c),g.push(g[m]+3*f[m].centre[0]);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var f=e.bestDotPlacements(d,b,a);0<f.length&&k.modify.push(q.clone().set({left:g[g.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d);break;case "virga":m=a.zone.ulx+f[0].centre[0];c=f[0].clone().set({left:m,top:b[0]});k.modify.push(c);a.components[0].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,0),k.modify.push(q.clone().set({left:c.left+2*f[0].centre[0],top:l[0]})));l=c.left+f[0].centre[0]-1;h=this.rendEng.createLine([l,b[0],l,b[0]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(h);this.drawLedgerLines([a.rootSystemPos],[m],2*f[0].centre[0],d);break;case "bivirga":case "trivirga":g=
[];g.push(a.zone.ulx+f[0].centre[0]);for(m=0;m<a.components.length;m++)c=f[m].clone().set({left:g[m],top:b[m]}),k.modify.push(c),l=c.left+f[m].centre[0]-1,h=this.rendEng.createLine([l,b[m],l,b[m]+1.5*d.delta_y],{strokeWidth:2,interact:!0}),k.fixed.push(h),g.push(g[m]+3*f[m].centre[0]);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var f=e.bestDotPlacements(d,b,a);0<f.length&&k.modify.push(q.clone().set({left:g[g.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+
b.pitchDiff}),g,2*f[0].centre[0],d);break;case "clivis":g=[];g.push(a.zone.ulx+f[0].centre[0]);var p=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(p);l=p.left+f[0].centre[0]-1;h=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);g.push(g[0]+2*f[1].centre[0]);var n=f[1].clone().set({left:g[1],top:b[1]});k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:n.left+
2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "cephalicus":g=[];m=this.rendEng.getGlyph("cephalicus");g.push(a.zone.ulx+m.centre[0]);p=m.clone().set({left:g[0],top:b[0]-m.centre[1]/2});k.modify.push(p);c=g[0]-m.centre[0]+1;h=this.rendEng.createLine([c,b[0],c,a.zone.lry],{strokeWidth:2,interact:!0});k.fixed.push(h);l=p.left+m.centre[0]-2;h=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,
interact:!0});k.fixed.push(h);c=this.rendEng.getGlyph("liques_up");g.push(g[0]+m.centre[0]-c.centre[0]);n=c.clone().set({left:g[1],top:b[1]-c.centre[1]/2});k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:n.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":g=
[];g.push(a.zone.ulx+f[0].centre[0]);m=f[0].centre[0];c=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(c);l=c.left+f[0].centre[0]-1;h=this.rendEng.createLine([l,b[0],l,b[0]+1.5*d.delta_y],{strokeWidth:2,interact:!0});k.fixed.push(h);for(c=1;c<a.components.length;c++)g.push(g[c-1]+2*f[c-1].centre[0]-1),1==c&&(g[1]+=m),l=f[c].clone().set({left:g[c],top:b[c]}),k.modify.push(l);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&k.modify.push(q.clone().set({left:g[a]+
2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "torculus":g=[];g.push(a.zone.ulx+f[0].centre[0]);g.push(g[0]+2*f[0].centre[0]-1);g.push(g[1]+2*f[1].centre[0]-1);p=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(p);l=p.left+f[0].centre[0]-1;h=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);n=f[1].clone().set({left:g[1],top:b[1]});k.modify.push(n);l=n.left+
f[1].centre[0]-1;h=this.rendEng.createLine([l,b[1],l,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(h);c=f[2].clone().set({left:g[2],top:b[2]});k.modify.push(c);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,b,a);0<h.length&&k.modify.push(q.clone().set({left:g[a]+2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "torculus.resupinus.1":case "torculus.resupinus.2":case "torculus.resupinus.3":case "torculus.resupinus.4":g=
[];g.push(a.zone.ulx+f[0].centre[0]);p=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(p);var l=this.rendEng.getGlyph("porrect_1"),r=l.clone().set({left:g[0]+f[0].centre[0]+l.centre[0]-1,top:b[1]+l.centre[1]/2});k.modify.push(r);var c=r.left-l.centre[0],h=b[0],u=r.top+l.centre[1],h=this.rendEng.createLine([c,b[1],c,h],{strokeWidth:2,interact:!0});k.fixed.push(h);"torculus.resupinus.1"==a.typeid?g.push(r.left+l.centre[0]-f[3].centre[0]):g.push(r.left+l.centre[0]+f[3].centre[0]);c=f[3].clone().set({left:g[1],
top:b[3]});k.modify.push(c);l=r.left+l.centre[0]-1;h=this.rendEng.createLine([l,b[3],l,b[2]],{strokeWidth:2,interact:!0});k.fixed.push(h);"torculus.resupinus.2"==a.typeid&&(l=c.left+f[3].centre[0]-1,h=this.rendEng.createLine([l,b[4],l,b[3]],{strokeWidth:2,interact:!0}),k.fixed.push(h));for(c=4;c<a.components.length;c++)g.push(g[g.length-1]+2*f[c].centre[0]-1),l=f[c].clone().set({left:g[g.length-1],top:b[c]}),k.modify.push(l);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var h=e.bestDotPlacements(d,
b,a);0<h.length&&k.modify.push(q.clone().set({left:g[a]+2*f[1].centre[0],top:h[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "podatus":g=[];g.push(a.zone.ulx+f[0].centre[0]);p=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(p);g.push(g[0]+2*f[1].centre[0]);n=f[1].clone().set({left:g[1],top:b[1]});k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&
k.modify.push(q.clone().set({left:p.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "epiphonus":g=[];m=this.rendEng.getGlyph("podatus_ep");g.push(a.zone.ulx+m.centre[0]);p=m.clone().set({left:g[0],top:b[0]});k.modify.push(p);l=p.left+m.centre[0]-2;h=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);c=this.rendEng.getGlyph("liques_down");g.push(g[0]+m.centre[0]-
c.centre[0]);n=c.clone().set({left:g[1],top:b[1]+c.centre[1]/2});k.modify.push(n);$.each(a.components,function(a,c){if(c.hasOrnament("dot")){var g=e.bestDotPlacements(d,b,a);0<g.length&&k.modify.push(q.clone().set({left:p.left+2*f[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "porrectus":m=a.components[0].pitchDiff+a.components[1].pitchDiff;l=null;switch(m){case -1:l=this.rendEng.getGlyph("porrect_1");
break;case -2:l=this.rendEng.getGlyph("porrect_2");break;case -3:l=this.rendEng.getGlyph("porrect_3");break;case -4:l=this.rendEng.getGlyph("porrect_4");break;default:l=this.rendEng.getGlyph("porrect_4")}r=l.clone().set({left:a.zone.ulx+l.centre[0],top:b[0]+l.centre[1]/2});k.modify.push(r);c=r.left-l.centre[0]+1;h=a.zone.lry;u=r.top+l.centre[1];a.zone.lry<r.top+u&&(h=u);h=this.rendEng.createLine([c,b[0],c,h],{strokeWidth:2,interact:!0});k.fixed.push(h);g=r.left+l.centre[0]-f[2].centre[0];c=f[2].clone().set({left:g,
top:b[2]});l=c.left+f[2].centre[0]-1;h=this.rendEng.createLine([l,b[2],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);k.modify.push(c);a.components[2].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,2),0<l.length&&k.modify.push(q.clone().set({left:c.left+2*f[2].centre[0],top:l[0]})));this.drawLedgerLines([a.rootSystemPos+a.components[2].pitchDiff],[g],2*f[2].centre[0],d);break;case "porrectus.flexus":l=this.rendEng.getGlyph("porrect_1");r=l.clone().set({left:a.zone.ulx+l.centre[0],top:b[0]+
l.centre[1]/2});k.modify.push(r);c=r.left-l.centre[0]+1;h=a.zone.lry;u=r.top+l.centre[1];a.zone.lry<r.top+u&&(h=u);h=this.rendEng.createLine([c,b[0],c,h],{strokeWidth:2,interact:!0});k.fixed.push(h);g=[];g.push(r.left+l.centre[0]+f[2].centre[0]);c=f[2].clone().set({left:g[0],top:b[2]});l=g[0]-f[2].centre[0]-1;h=this.rendEng.createLine([l,b[2],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);k.modify.push(c);for(c=3;c<a.components.length;c++)g.push(g[g.length-1]+2*f[c].centre[0]-1),l=f[c].clone().set({left:g[g.length-
1],top:b[c]}),k.modify.push(l);for(c=2;c<a.components.length;c++)a.components[c].hasOrnament("dot")&&(l=e.bestDotPlacements(d,b,m),0<l.length&&k.modify.push(q.clone().set({left:p.left+2*f[1].centre[0],top:l[0]})));break;case "scandicus.1":case "scandicus.2":case "scandicus.3":case "scandicus.4":m=a.components.length;r=a.zone.ulx-f[0].centre[0];g=[];for(c=0;c<m-1;c+=2)for(yoffset=0,1==Math.abs(a.components[c+1].pitchDiff-a.components[c].pitchDiff)&&(yoffset=1),r+=2*f[c].centre[0]-1,g.push(r),l=f[c].clone().set({left:g[c],
top:b[c]-f[c].centre[1]/2+yoffset}),k.modify.push(l),g.push(g[c]+2*f[c+1].centre[0]),n=f[c+1].clone().set({left:g[c+1],top:b[c+1]-yoffset}),k.modify.push(n),h=c;h<c+2;h++)a.components[h].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,h),0<l.length&&k.modify.push(q.clone().set({left:n.left+2*f[h].centre[0],top:l[0]})));1==a.components.length%2&&(r+=2*f[m-1].centre[0]-1,g.push(r),c=f[m-1].clone().set({left:r,top:b[m-1]}),k.modify.push(c),a.components[m-1].hasOrnament("dot")&&(l=this.bestDotPlacements(d,
b,m-1),0<l.length&&k.modify.push(q.clone().set({left:c.left+2*f[m-1].centre[0],top:l[0]}))));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d);break;case "scandicus.flexus.1":g=[];g.push(a.zone.ulx+f[0].centre[0]);p=f[0].clone().set({left:g[0],top:b[0]});k.modify.push(p);l=p.left+f[0].centre[0];h=this.rendEng.createLine([l,b[0],l,b[1]],{strokeWidth:2,interact:!0});k.fixed.push(h);g.push(g[0]+2*f[1].centre[0]);n=f[1].clone().set({left:g[1],
top:b[1]});k.modify.push(n);for(h=0;2>h;h++)a.components[h].hasOrnament("dot")&&(l=this.bestDotPlacements(d,b,h),0<l.length&&k.modify.push(q.clone().set({left:g[h]+2*f[h].centre[0],top:l[0]})));g.push(g[1]+2*f[2].centre[0]);c=f[2].clone().set({left:g[2],top:b[2]});k.modify.push(c);l=g[2]+f[2].centre[0]-1;h=this.rendEng.createLine([l,b[2],l,b[3]],{strokeWidth:2,interact:!0});k.fixed.push(h);g.push(g[2]+2*f[3].centre[0]);c=f[3].clone().set({left:g[3],top:b[3]});k.modify.push(c);for(h=2;h<a.components.length;h++)a.components[h].hasOrnament("dot")&&
(l=e.bestDotPlacements(d,b,m),0<l.length&&k.modify.push(q.clone().set({left:n.left+2*f[1].centre[0],top:l[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootSystemPos+b.pitchDiff}),g,2*f[0].centre[0],d)}this.drawing=this.rendEng.draw(k,{group:!0,selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.SquareNoteInteraction=function(a,b,d,e){Toe.View.Interaction.call(this,a,b,d,e);b={initMode:"edit"};$.extend(b,e);this.systemDwg=this.clefDwg=this.divisionDwg=this.punctDwg=null;e=a.getGlyph("punctum").clone();this.punctWidth=e.width*a.getGlobalScale();this.punctHeight=e.height*a.getGlobalScale();this.objMoving=!1;$("#btn_edit").bind("click.edit",{gui:this,parentDivId:"#gui-sidebar"},this.handleEdit);$("#btn_insert").bind("click.insert",{gui:this,parentDivId:"#gui-sidebar"},this.handleInsert);
$("#btn_"+b.initMode).trigger("click");this.bindHotKeys();$("#btn_update_all_custodes").bind("click",{gui:this},this.handleUpdateAllCustodes)};Toe.View.SquareNoteInteraction.prototype=new Toe.View.Interaction;Toe.View.SquareNoteInteraction.prototype.constructor=Toe.View.SquareNoteInteraction;
Toe.View.SquareNoteInteraction.prototype.handleEdit=function(a){var b=a.data.gui;b.hideInfo();b.activateCanvasObjects();b.removeInsertControls();b.removeInsertSubControls();b.unbindEventHandlers();b.insertEditControls(a.data.parentDivId);b.removeEditSubControls();b.rendEng.canvas.observe("object:modified",function(a){b.handleEventObjectModified(a)});b.rendEng.canvas.observe("object:moving",function(a){b.objMoving=!0});b.rendEng.canvas.observe("object:selected",function(a){b.handleEventObjectSelected(a)});
b.rendEng.canvas.observe("selection:cleared",function(a){b.handleEventSelectionCleared(a)});b.rendEng.canvas.observe("selection:created",function(a){b.handleEventSelectionCreated(a)});b.rendEng.canvas.observe("mouse:down",function(a){b.downCoords=b.rendEng.canvas.getPointer(a.e)});b.rendEng.canvas.observe("mouse:up",function(a){a=b.rendEng.canvas.getPointer(a.e);var e=b.downCoords.x-a.x,f=b.downCoords.y-a.y;if(b.objMoving){var h=b.rendEng.canvas.getActiveObject();h||(h=b.rendEng.canvas.getActiveGroup());
if(h){var c=[];h.eleRef?c.push(h):$.each(h.objects,function(a,b){c.push(b)});$.each(c,function(a,d){var m=d.eleRef;if(m instanceof Toe.Model.Clef){var l=d.left,g=d.top;1<c.length&&(l=h.left+d.left,g=h.top+d.top);l=m.system.getSystemSnapCoordinates({x:l,y:g},null,{ignoreEle:m},b);l=-Math.round((l.y-m.system.zone.uly)/(m.system.delta_y/2));m.setSystemPosition(l);l=m.system.getPitchedElements({neumes:!0,custos:!1});if(0<l.length&&m.system.getActingClefByEle(l[0])==m){var p=b.page.getPreviousSystem(m.system);
p&&b.handleUpdatePrevCustos(l[0].components[0].pname,l[0].components[0].oct,p)}var l=$.map(m.system.getPitchedElements({clef:m}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){b.showAlert("Server failed to move custos. Client and server are not synchronized.")})}}),
g=m.system.props.numLines+m.props.systemPos/2,p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]),n={id:m.id,line:g,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3],pitchInfo:l};$.post(b.apiprefix+"/move/clef",{data:JSON.stringify(n)}).error(function(){b.showAlert("Server failed to move clef. Client and server are not synchronized.")})}else if(m instanceof Toe.Model.Neume){l=d.left;g=d.top;1<c.length&&(l=h.left+d.left,g=h.top+d.top);var r={x:l,y:m.system.zone.uly-m.rootSystemPos*m.system.delta_y/
2-f},u=b.page.getClosestSystem(r),t=u.getSystemSnapCoordinates(r,d.currentWidth,{ignoreEle:m},b),l=Math.round((u.zone.uly-t.y)/(u.delta_y/2)),p=t.x-d.currentWidth/2,g=g-d.currentHeight/2-(r.y-t.y),p=[p,g,p+d.currentWidth,g+d.currentHeight];m.setBoundingBox(p);r=m.rootSystemPos;$.each(m.components,function(a,b){var c=u.calcPitchFromCoords({x:t.x,y:t.y-u.delta_y/2*b.pitchDiff});b.setPitchInfo(c.pname,c.oct)});$(m).trigger("vEraseDrawing");m.system.removeElementByRef(m);g=u.addNeume(m);1==c.length&&
$(m).trigger("vSelectDrawing");p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]);n={id:m.id,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3]};r!=l?(n.pitchInfo=[],$.each(m.components,function(a,b){n.pitchInfo.push({pname:b.pname,oct:b.oct})}),l=u.getPitchedElements({neumes:!0,custos:!1}),m==l[0]&&(p=b.page.getPreviousSystem(u))&&b.handleUpdatePrevCustos(m.components[0].pname,m.components[0].oct,p)):n.pitchInfo=null;g+1<u.elements.length?n.beforeid=u.elements[g+1].id:(l=b.page.getNextSystem(u),
n.beforeid=l.id);$.post(b.apiprefix+"/move/neume",{data:JSON.stringify(n)}).error(function(){b.showAlert("Server failed to move neume. Client and server are not synchronized.")})}else if(m instanceof Toe.Model.Division){l=d.left;g=d.top;1<c.length&&(l+=h.left,g+=h.top);r={x:l,y:g};l=b.page.getClosestSystem(r);t=l.getSystemSnapCoordinates(r,d.currentWidth,{x:!0,y:!1},b);switch(m.type){case Toe.Model.Division.Type.div_small:t.y=l.zone.uly;break;case Toe.Model.Division.Type.div_minor:t.y=l.zone.uly+
(l.zone.lry-l.zone.uly)/2;break;case Toe.Model.Division.Type.div_major:t.y=l.zone.uly+(l.zone.lry-l.zone.uly)/2;break;case Toe.Model.Division.Type.div_final:t.y=l.zone.uly+(l.zone.lry-l.zone.uly)/2}m.system.removeElementByRef(m);b.rendEng.canvas.remove(d);b.rendEng.repaint();p=t.x-d.currentWidth/2;g=t.y-d.currentHeight/2;p=[p,g,p+d.currentWidth,g+d.currentHeight];m.setBoundingBox(p);p=l.addDivision(m);1==c.length&&m.selectDrawing();g=null;p+1<l.elements.length?g=l.elements[p+1].id:(l=b.page.getNextSystem(l),
g=l.id);p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]);$.post(b.apiprefix+"/move/division",{id:m.id,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3],beforeid:g}).error(function(){b.showAlert("Server failed to move division. Client and server are not synchronized.")})}else m instanceof Toe.Model.Custos&&(l=d.left,g=d.top,1<c.length&&(d.left=l+e,d.top=g+f))});1<c.length&&b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()}b.objMoving=!1}});$("#btn_delete").unbind("click");$("#btn_neumify").unbind("click");
$("#btn_ungroup").unbind("click");$("#btn_delete").bind("click.edit",{gui:b},b.handleDelete);$("#btn_neumify").bind("click.edit",{gui:b},b.handleNeumify);$("#btn_neumify_liquescence").bind("click.edit",{gui:b,modifier:"alt"},b.handleNeumify);$("#btn_ungroup").bind("click.edit",{gui:b},b.handleUngroup)};
Toe.View.SquareNoteInteraction.prototype.handleDotToggle=function(a){var b=a.data.gui,d=a.data.punctum;if(a=d.components[0].hasOrnament("dot"))d.components[0].removeOrnament("dot");else{var e=new Toe.Model.Ornament("dot",{form:"aug"});d.components[0].addOrnament(e)}d.syncDrawing();e=b.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);d={id:d.id,dotform:"aug",ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]};a?$.post(b.apiprefix+"/delete/dot",d).error(function(){b.showAlert("Server failed to remove dot from the punctum. Client and server are not synchronized.")}):
$.post(b.apiprefix+"/insert/dot",d).error(function(){b.showAlert("Server failed to add a dot to the punctum. Client and server are not synchronized.")});$(this).toggleClass("active")};
Toe.View.SquareNoteInteraction.prototype.handleHeadShapeChange=function(a){var b=a.data.gui,d=a.data.shape;a=a.data.punctum;a.components[0].setHeadShape(d);"virga"==d?(a.name="Virga",a.typeid="virga"):"cavum"==d&&(a.name="Cavum",a.typeid="cavum");a.syncDrawing();var e=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/update/neume/headshape",{id:a.id,shape:d,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){b.showAlert("Server failed to change note head shape. Client and server are not synchronized.")})};
Toe.View.SquareNoteInteraction.prototype.handleClefShapeChange=function(a){var b=a.data.gui,d=a.data.clef;a=a.data.shape;if(d.shape!=a){d.setShape(a);var e=d.system.getPitchedElements({neumes:!0,custos:!1});if(0<e.length&&d.system.getActingClefByEle(e[0])==d){var f=b.page.getPreviousSystem(d.system);f&&b.handleUpdatePrevCustos(e[0].components[0].pname,e[0].components[0].oct,f)}e=$.map(d.system.getPitchedElements({clef:d}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,
b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){b.showAlert("Server failed to move custos. Client and server are not synchronized.")})}});f=b.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);$.post(b.apiprefix+"/update/clef/shape",{data:JSON.stringify({id:d.id,
shape:a,ulx:f[0],uly:f[1],lrx:f[2],lry:f[3],pitchInfo:e})}).error(function(){b.showAlert("Server failed to update clef shape. Client and server are not synchronized.")});$(this).toggleClass("active")}};
Toe.View.SquareNoteInteraction.prototype.handleNeumify=function(a){var b=a.data.gui;a=a.data.modifier;var d=b.rendEng.canvas.getActiveGroup();if(d){var e=[],f=null;$.each(d.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&(f||(f=b.eleRef.system),b.eleRef.system==f&&e.push(b))});if(!(2>e.length)){e.sort(function(a,b){return a.eleRef.zone.ulx-b.eleRef.zone.ulx});var h=new Toe.Model.SquareNoteNeume({modifier:a});numPunct=0;var c=[],q=Number.MAX_VALUE,k=Number.MAX_VALUE,m=Number.MIN_VALUE;
$.each(e,function(a,e){$.merge(h.components,e.eleRef.components);numPunct+=e.eleRef.components.length;c.push(e.eleRef.id);var g=d.top+e.top;q=Math.min(q,d.left+e.left-e.currentHeight/2);k=Math.min(k,g-e.currentHeight/2);m=Math.max(m,g+e.currentHeight/2);f.removeElementByRef(e.eleRef);b.rendEng.canvas.remove(e)});h.setBoundingBox([q,k,q+numPunct*b.punctWidth,m]);a=new Toe.View.NeumeView(b.rendEng,b.page.documentType);new Toe.Ctrl.NeumeController(h,a);f.addNeume(h);a=b.getOutputBoundingBox([h.zone.ulx,
h.zone.uly,h.zone.lrx,h.zone.lry]);var l=h.typeid,g=$.map(h.components,function(a){return a.props.type});a=JSON.stringify({nids:c.join(","),typeid:l,headShapes:g,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3]});$.post(b.apiprefix+"/neumify",{data:a},function(a){h.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to neumify selected neumes. Client and server are not synchronized.")});b.rendEng.canvas.discardActiveGroup();$(h).trigger("vSelectDrawing");b.rendEng.repaint()}}};
Toe.View.SquareNoteInteraction.prototype.handleUngroup=function(a){var b=a.data.gui,d=[];(a=b.rendEng.canvas.getActiveObject())?a.eleRef instanceof Toe.Model.Neume&&1<a.eleRef.components.length&&d.push(a):(a=b.rendEng.canvas.getActiveGroup())&&$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&1<b.eleRef.components.length&&d.push(b)});var e=[],f=[],h=[];$.each(d,function(a,d){e.push(d.eleRef.id);var k=[],m=d.eleRef.zone.ulx;d.eleRef.system.removeElementByRef(d.eleRef);b.rendEng.canvas.remove(d);
$.each(d.eleRef.components,function(a,c){var f=new Toe.Model.SquareNoteNeume;f.components.push(c);var e=d.eleRef.system.zone.uly-(d.eleRef.rootSystemPos+c.pitchDiff)*d.eleRef.system.delta_y/2-b.punctHeight/2;f.setBoundingBox([m+a*b.punctWidth,e,m+(a+1)*b.punctWidth,e+b.punctHeight]);e=new Toe.View.NeumeView(b.rendEng,b.page.documentType);new Toe.Ctrl.NeumeController(f,e);d.eleRef.system.addNeume(f);e=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);k.push({ulx:e[0],uly:e[1],lrx:e[2],
lry:e[3]});h.push(f)});f.push(k)});a=JSON.stringify({nids:e.join(","),bbs:f});$.post(b.apiprefix+"/ungroup",{data:a},function(a){var b=JSON.parse(a).nids,b=$.map(b,function(a){return a});$.each(h,function(a,c){c.id=b[a]})}).error(function(){b.showAlert("Server failed to ungroup selected neumes. Client and server are not synchronized.")});b.rendEng.canvas.discardActiveObject();b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()};
Toe.View.SquareNoteInteraction.prototype.handleInsert=function(a){var b=a.data.gui;a=a.data.parentDivId;b.hideInfo();b.deactivateCanvasObjects();b.removeInsertControls();b.unbindInsertControls();b.removeEditControls();b.unbindEditControls();b.unbindEditSubControls();b.unbindEventHandlers();b.insertInsertControls(a)};
Toe.View.SquareNoteInteraction.prototype.handleInsertPunctum=function(a){var b=a.data.gui;b.unbindEventHandlers();b.removeInsertSubControls();0==$("#menu_insertpunctum").length&&$("#sidebar-insert").append('<span id="menu_insertpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="chk_dot" class="btn">&#149; Dot</button>\n<button id="chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li></span>');var d=
!1,e=function(a){var e={modify:[],fixed:[]},c=null,q=b.rendEng.getGlyph("punctum");a?c={left:-50,top:-50}:(c={left:b.punctDwg.left,top:b.punctDwg.top},d&&(a=b.rendEng.getGlyph("dot").clone().set({left:c.left+b.punctWidth,top:c.top,opacity:.6}),e.modify.push(a)));c=q.clone().set({left:c.left,top:c.top,opacity:.6});e.modify.push(c);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.punctDwg=b.rendEng.draw(e,{group:!0,selectable:!1,repaint:!0})[0]};e(!0);b.rendEng.canvas.observe("mouse:move",function(a){a=
b.rendEng.canvas.getPointer(a.e);b.punctDwg.left=a.x-b.punctDwg.currentWidth/4;b.punctDwg.top=a.y-b.punctDwg.currentHeight/4;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var e={x:b.punctDwg.left,y:b.punctDwg.top};a=b.page.getClosestSystem(e);var c=new Toe.Model.SquareNoteNeume,e=a.getSystemSnapCoordinates(e,b.punctDwg.currentWidth,{},b),q=e.x-b.punctDwg.currentWidth/2,k=e.y-b.punctDwg.currentHeight/2;c.setBoundingBox([q,k,q+b.punctDwg.currentWidth,k+b.punctDwg.currentHeight]);
var e=a.calcPitchFromCoords(e),q=e.pname,k=e.oct,e={pname:q,oct:k},m=[];d&&(m.push(new Toe.Model.Ornament("dot",{form:"aug"})),e.dotform="aug");m=new Toe.Model.SquareNoteNeumeComponent(q,k,{type:"punctum",ornaments:m});c.addComponent(m);m=new Toe.View.NeumeView(b.rendEng,b.page.documentType);new Toe.Ctrl.NeumeController(c,m);m=a.addNeume(c);if(1==m){var l=b.page.getPreviousSystem(a);l&&b.handleUpdatePrevCustos(q,k,l)}q=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);e.ulx=q[0];
e.uly=q[1];e.lrx=q[2];e.lry=q[3];m+1<a.elements.length?e.beforeid=a.elements[m+1].id:(a=b.page.getNextSystem(a))?e.beforeid=a.id:e.pageid=b.page.id;$.post(b.apiprefix+"/insert/neume",e,function(a){c.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to insert neume. Client and server are not synchronized.")})});$("#chk_dot").bind("click.insert",function(){d=d?!1:!0;e(!1)})};
Toe.View.SquareNoteInteraction.prototype.handleInsertDivision=function(a){var b=a.data.gui;b.unbindEventHandlers();b.removeInsertSubControls();0==$("#menu_insertdivision").length&&$("#sidebar-insert").append('<span id="menu_insertdivision"><br/>\n<li class="nav-header">Division Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_small" class="btn">Small</button>\n<button id="rad_minor" class="btn">Minor</button>\n<button id="rad_major" class="btn">Major</button>\n<button id="rad_final" class="btn">Final</button>\n</div>\n</li>\n</span>');
var d=null,e=null;b.rendEng.canvas.observe("mouse:move",function(a){a=b.rendEng.canvas.getPointer(a.e);e=b.page.getClosestSystem(a);var h={strokeWidth:4,opacity:.6};switch(d){case "div_small":a.y=e.zone.uly;if(!b.divisionDwg){var c=e.zone.uly-e.delta_y/2,q=e.zone.uly+e.delta_y/2,k=a.x;b.divisionDwg=b.rendEng.createLine([k,c,k,q],h);b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:.6})}break;case "div_minor":a.y=e.zone.uly+(e.zone.lry-e.zone.uly)/2;b.divisionDwg||(c=e.zone.uly+
e.delta_y/2,q=c+2*e.delta_y,k=a.x,b.divisionDwg=b.rendEng.createLine([k,c,k,q],h),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:.6}));break;case "div_major":a.y=e.zone.uly+(e.zone.lry-e.zone.uly)/2;b.divisionDwg||(c=e.zone.uly,q=e.zone.lry,k=a.x,b.divisionDwg=b.rendEng.createLine([k,c,k,q],h),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:.6}));break;case "div_final":if(a.y=e.zone.uly+(e.zone.lry-e.zone.uly)/2,!b.divisionDwg){var c=e.zone.uly,q=e.zone.lry,
k=a.x,m=a.x+b.punctWidth,k=b.rendEng.createLine([k,c,k,q],h),h=b.rendEng.createLine([m,c,m,q],h);b.divisionDwg=b.rendEng.draw({fixed:[k,h],modify:[]},{group:!0,selectable:!1,opacity:.6})[0]}}h=a.x-b.divisionDwg.currentWidth/2;c=a.x+b.divisionDwg.currentWidth/2;e.elements[0]instanceof Toe.Model.Clef&&h<=e.elements[0].zone.lrx?a.x=e.elements[0].zone.lrx+b.divisionDwg.currentWidth/2+1:h<=e.zone.ulx&&(a.x=e.zone.ulx+b.divisionDwg.currentWidth/2+1);e.custos&&c>=e.custos.zone.ulx?a.x=e.custos.zone.ulx-
b.divisionDwg.currentWidth/2-3:c>=e.zone.lrx&&(a.x=e.zone.lrx-b.divisionDwg.currentWidth/2-3);b.divisionDwg.left=a.x;b.divisionDwg.top=a.y;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var h=e.getSystemSnapCoordinates({x:b.divisionDwg.left,y:b.divisionDwg.top},b.divisionDwg.currentWidth,{},b),c=new Toe.Model.Division(d);a=h.x-b.divisionDwg.currentWidth/2;h=h.y-b.divisionDwg.currentHeight/2;h=[a,h,a+b.divisionDwg.currentWidth,h+b.divisionDwg.currentHeight];c.setBoundingBox(h);
a=new Toe.View.DivisionView(b.rendEng);new Toe.Ctrl.DivisionController(c,a);a=e.addDivision(c);h=b.getOutputBoundingBox(h);h={type:c.key.slice(4),ulx:h[0],uly:h[1],lrx:h[2],lry:h[3]};a+1<e.elements.length?h.beforeid=e.elements[a+1].id:(a=b.page.getNextSystem(e),h.beforeid=a.id);$.post(b.apiprefix+"/insert/division",h,function(a){c.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to insert division. Client and server are not synchronized.")})});$("#rad_small").bind("click.insert",
function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);d="div_small"});$("#rad_minor").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);d="div_minor"});$("#rad_major").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);d="div_major"});$("#rad_final").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);d=
"div_final"});$("#rad_small").trigger("click")};
Toe.View.SquareNoteInteraction.prototype.handleInsertSystem=function(a){var b=a.data.gui;b.unbindEventHandlers();b.removeInsertSubControls();b.insertInsertSystemSubControls();b.updateInsertSystemSubControls();var d=b.page.getWidestSystem();if(null!=d){b.systemDrawing=null;a=d.props.numLines;for(var e=d.getWidth(),d=d.delta_y,f={fixed:[],modify:[]},h=0;h<a;h++)f.fixed.push(b.rendEng.createLine([0,d*h,e,d*h]));b.systemDrawing=b.rendEng.draw(f,{group:!0,selectable:!1,opacity:.6})[0];b.rendEng.canvas.observe("mouse:move",
function(a){a=b.rendEng.canvas.getPointer(a.e);b.systemDrawing.left=a.x;b.systemDrawing.top=a.y;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){a=b.systemDrawing.left-Math.round(b.systemDrawing.currentWidth/2);var d=b.systemDrawing.top-Math.round(b.systemDrawing.currentHeight/2),e=new Toe.Model.SquareNoteSystem([a,d,a+b.systemDrawing.currentWidth,d+b.systemDrawing.currentHeight],null,b.page);a=new Toe.View.SystemView(b.rendEng);new Toe.Ctrl.SystemController(e,a);e.setOrderNumber($("#system_number_slider").val());
b.page.addSystem(e);b.updateInsertSystemSubControls();var f=b.page.getNextSystem(e);a=b.getOutputBoundingBox([e.zone.ulx,e.zone.uly,e.zone.lrx,e.zone.lry]);a={ordernumber:e.orderNumber,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3]};null!=f&&(a.nextsbid=f.id);$.post(b.apiprefix+"/insert/systembreak",a,function(a){e.setID(JSON.parse(a).id);for(e.setSystemID(JSON.parse(a).id);null!=f;)b.postSystemBreakEditOrder(f.id,f.orderNumber),f=b.page.getNextSystem(f)}).error(function(){b.showAlert("Server failed to insert system break.  Client and server are not synchronized.")})})}};
Toe.View.SquareNoteInteraction.prototype.handleInsertClef=function(a){var b=a.data.gui;b.unbindEventHandlers();b.removeInsertSubControls();0==$("#menu_insertclef").length&&$("#sidebar-insert").append('<span id="menu_insertclef"><br/>\n<li class="nav-header">Clef Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_doh" class="btn">C</button>\n<button id="rad_fah" class="btn">F</button>\n</div>\n</li>\n</span>');var d=null;b.rendEng.canvas.observe("mouse:move",function(a){a=
b.rendEng.canvas.getPointer(a.e);var f=0,h=0;"c"==d?f=b.clefDwg.currentWidth/4:(f=b.clefDwg.currentWidth/8,h=b.clefDwg.currentHeight/8);b.clefDwg.left=a.x-f;b.clefDwg.top=a.y+h;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var f={x:b.clefDwg.left,y:b.clefDwg.top};"f"==d&&(f.x-=b.clefDwg.currentWidth/8,f.y-=b.clefDwg.currentHeight/8);a=b.page.getClosestSystem(f);if(f.x<a.zone.ulx-10||f.x>a.zone.lrx+10||f.y<a.zone.uly-10||f.y>a.zone.lry+10)b.showHeadsUp("Clef must be positioned on a system."),
window.setTimeout(function(){b.hideHeadsUp()},3E3);else{var h=a.getSystemSnapCoordinates(f,b.clefDwg.currentWidth,{},b),f=Math.round((a.zone.uly-h.y)/(a.delta_y/2)),c=new Toe.Model.Clef(d,{systemPos:f}),q=h.x-b.clefDwg.currentWidth/2,h=h.y-b.clefDwg.currentHeight/2;c.setBoundingBox([q,h,q+b.clefDwg.currentWidth,h+b.clefDwg.currentHeight]);q=new Toe.View.ClefView(b.rendEng);new Toe.Ctrl.ClefController(c,q);q=a.addClef(c);f=a.props.numLines+f/2;h=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,
c.zone.lry]);f={shape:d,line:f,ulx:h[0],uly:h[1],lrx:h[2],lry:h[3]};q+1<a.elements.length?f.beforeid=a.elements[q+1].id:(q=b.page.getNextSystem(a))?f.beforeid=q.id:f.pageid=b.page.id;q=a.getPitchedElements({neumes:!0,custos:!1});0<q.length&&a.getActingClefByEle(q[0])==c&&(h=b.page.getPreviousSystem(a))&&b.handleUpdatePrevCustos(q[0].components[0].pname,q[0].components[0].oct,h);f.pitchInfo=$.map(a.getPitchedElements({clef:c}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,
function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){b.showAlert("Server failed to move custos. Client and server are not synchronized.")})}});$.post(b.apiprefix+"/insert/clef",{data:JSON.stringify(f)},function(a){c.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to insert clef. Client and server are not synchronized.")})}});
$("#rad_doh").unbind("click");$("#rad_fah").unbind("click");$("#rad_doh").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("c_clef").clone().set($.extend(a,{opacity:.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:.6,selectable:!1,repaint:!0})[0];d="c"}});$("#rad_fah").bind("click.insert",function(){if(!$(this).hasClass("active")){var a=
{left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("f_clef").clone().set($.extend(a,{opacity:.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:.6,selectable:!1,repaint:!0})[0];d="f"}});$("#rad_doh").trigger("click")};
Toe.View.SquareNoteInteraction.prototype.handleUpdatePrevCustos=function(a,b,d){var e=this;if(d.getActingClefByCoords({x:d.zone.lrx})){var f=e.page.getNextSystem(d);if(!f||f.elements[0]instanceof Toe.Model.Clef)if(f=d.custos){f.setRootNote(a,b);var h=d.getActingClefByEle(f);f.setRootSystemPos(d.calcSystemPosFromPitch(a,b,h));h=this.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);$.post(this.apiprefix+"/move/custos",{id:f.id,pname:a,oct:b,ulx:h[0],uly:h[1],lrx:h[2],lry:h[3]}).error(function(){e.showAlert("Server failed to move custos. Client and server are not synchronized.")})}else{var c=
new Toe.Model.Custos(a,b),f=d.zone.lrx-e.punctWidth/2,h=d.zone.uly;c.setBoundingBox([f,h,f+e.punctWidth,h+e.punctHeight]);f=new Toe.View.CustosView(e.rendEng);new Toe.Ctrl.CustosController(c,f);d.setCustos(c);h=this.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);a={id:c.id,pname:a,oct:b,ulx:h[0],uly:h[1],lrx:h[2],lry:h[3]};if(f=e.page.getNextSystem(d))a.beforeid=f.id;$.post(this.apiprefix+"/insert/custos",a,function(a){c.id=JSON.parse(a).id}).error(function(){e.showAlert("Server failed to insert custos. Client and server are not synchronized.")})}}};
Toe.View.SquareNoteInteraction.prototype.handleUpdateAllCustodes=function(a){var b=a.data.gui;$.each(b.page.systems,function(a,e){var f=e.getPitchedElements({neumes:!0,custos:!1});if(0<f.length){var h=b.page.getPreviousSystem(e);h&&b.handleUpdatePrevCustos(f[0].components[0].pname,f[0].components[0].oct,h)}})};
Toe.View.SquareNoteInteraction.prototype.deleteActiveSelection=function(a){var b=this,d=!1,e=a.rendEng.canvas.getActiveObject();e?e.eleRef instanceof Toe.Model.System&&(d=!0):(e=a.rendEng.canvas.getActiveGroup())&&$.each(e.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.System&&(d=!0)});if(!d||window.confirm("Deleting a system will remove all neumes on it. Are you sure to proceed?")){toDelete={clefs:[],nids:[],dids:[],cids:[],systemIdArray:[],systemBreakIdArray:[]};var f=[],h=function(c,
d){var f=c.eleRef,e=f.system,h=e.getPreviousClef(f);e.removeElementByRef(f);var k=null;d||(e.updatePitchedElements(h),e=e.getPitchedElements(f),k=$.map(e,function(c){if(c instanceof Toe.Model.Neume){var d=[];$.each(c.components,function(a,b){d.push({pname:b.pname,oct:b.oct})});return{id:c.id,noteInfo:d}}if(c instanceof Toe.Model.Custos){var f=a.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);$.post(a.apiprefix+"/move/custos",{id:c.id,ulx:f[0],uly:f[1],lrx:f[2],lry:f[3]}).error(function(){b.showAlert("Server failed to move custos. Client and server are not synchronized.")})}}));
toDelete.clefs.push({id:f.id,pitchInfo:k});a.rendEng.canvas.remove(c)},c=function(c){var d=c.eleRef,f=d.system.getPitchedElements({neumes:!0,custos:!1});d.system.removeElementByRef(d);toDelete.nids.push(d.id);a.rendEng.canvas.remove(c);if(1==f.length)(d=a.page.getPreviousSystem(d.system))&&d.custos&&(d.custos.eraseDrawing(),d.removeElementByRef(d.custos),$.post(a.apiprefix+"/delete/custos",{ids:d.custos.id}).error(function(){b.showAlert("Server failed to delete custos. Client and server are not synchronized.")}),
d.custos=null);else if(d==f[0]&&(d=a.page.getPreviousSystem(d.system))&&d.custos){c=d.custos;var e=f[1],f=e.components[0].pname,e=e.components[0].oct,h=d.getActingClefByEle(c),d=d.calcSystemPosFromPitch(f,e,h);c.pname=f;c.oct=e;c.setRootSystemPos(d);d=a.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);$.post(a.apiprefix+"/move/custos",{id:c.id,pname:f,oct:e,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){b.showAlert("Server failed to move custos. Client and server are not synchronized.")})}},
q=function(b){var c=b.eleRef;c.system.removeElementByRef(c);toDelete.dids.push(c.id);a.rendEng.canvas.remove(b)},k=function(b){var c=b.eleRef;c.system.removeElementByRef(c);c.system.custos==c&&(c.system.custos=null);toDelete.cids.push(c.id);a.rendEng.canvas.remove(b)},m=function(b){var d=b.eleRef;toDelete.systemBreakIdArray.push(d.id);toDelete.systemIdArray.push(d.systemId);var e=0;for(doneRemovingElements=!1;!doneRemovingElements;)if(0===d.elements.length||e>=d.elements.length)doneRemovingElements=
!0;else{var l=d.elements[e],m=l.view.drawing;l instanceof Toe.Model.Clef?h(m,!0):l instanceof Toe.Model.Neume?c(m):l instanceof Toe.Model.Division?q(m):l instanceof Toe.Model.Custos?k(m):e++}d=a.page.removeSystem(d);f=f.concat(d);a.rendEng.canvas.remove(b)};if(e=a.rendEng.canvas.getActiveObject())e.eleRef instanceof Toe.Model.Clef?h(e,!1):e.eleRef instanceof Toe.Model.Neume?c(e):e.eleRef instanceof Toe.Model.Division?q(e):e.eleRef instanceof Toe.Model.Custos?k(e):e.eleRef instanceof Toe.Model.System&&
m(e),a.rendEng.repaint();else if(e=a.rendEng.canvas.getActiveGroup())$.each(e.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Clef?h(b,!1):b.eleRef instanceof Toe.Model.Neume?c(b):b.eleRef instanceof Toe.Model.Division?q(b):b.eleRef instanceof Toe.Model.Custos&&k(b)}),a.rendEng.canvas.discardActiveGroup(),a.rendEng.repaint();0<toDelete.nids.length&&$.post(a.apiprefix+"/delete/neume",{ids:toDelete.nids.join(",")}).error(function(){b.showAlert("Server failed to delete neume. Client and server are not synchronized.")});
0<toDelete.dids.length&&$.post(a.apiprefix+"/delete/division",{ids:toDelete.dids.join(",")}).error(function(){b.showAlert("Server failed to delete division. Client and server are not synchronized.")});0<toDelete.cids.length&&$.post(a.apiprefix+"/delete/custos",{ids:toDelete.cids.join(",")}).error(function(){b.showAlert("Server failed to delete custos. Client and server are not synchronized.")});0<toDelete.clefs.length&&$.post(a.apiprefix+"/delete/clef",{data:JSON.stringify(toDelete.clefs)}).error(function(){b.showAlert("Server failed to delete clef. Client and server are not synchronized.")});
0<toDelete.systemIdArray.length&&a.postSystemDelete(toDelete.systemIdArray);0<toDelete.systemBreakIdArray.length&&a.postSystemBreakDelete(toDelete.systemBreakIdArray);if(0<f.length){var l=[];$.each(f,function(a,b){-1===$.inArray(b,l)&&l.push(b)});for(e=0;e<f.length;e++)a.postSystemBreakEditOrder(f[e].id,f[e].orderNumber)}}};Toe.View.SquareNoteInteraction.prototype.postSystemBreakEditOrder=function(a,b){var d=this;$.post(this.apiprefix+"/modify/systembreak",{sbid:a,ordernumber:b}).error(function(){d.showAlert("Server failed to modify system break.  Client and server are not synchronized.")})};
Toe.View.SquareNoteInteraction.prototype.postSystemDelete=function(a){var b=this;$.post(this.apiprefix+"/delete/system",{sids:a.join(",")}).error(function(){b.showAlert("Server failed to delete system.  Client and server are not synchronized.")})};Toe.View.SquareNoteInteraction.prototype.postSystemBreakDelete=function(a){var b=this;$.post(this.apiprefix+"/delete/systembreak",{sbids:a.join(",")}).error(function(){b.showAlert("Server failed to delete system break.  Client and server are not synchronized.")})};
Toe.View.SquareNoteInteraction.prototype.postModifySystemZone=function(a,b,d,e,f){var h=this;$.post(this.apiprefix+"/update/system/zone",{sid:a,ulx:b,uly:d,lrx:e,lry:f}).error(function(){h.showAlert("Server failed to update system zone.  Client and server are not synchronized.")})};Toe.View.SquareNoteInteraction.prototype.handleDelete=function(a){a.data.gui.deleteActiveSelection(a.data.gui)};
Toe.View.SquareNoteInteraction.prototype.handleEventObjectModified=function(a){var b=this,d=[];a.target.hasOwnProperty("eleRef")?d.push(a.target):a.target.hasOwnProperty("objects")&&$.each(a.target.objects,function(a,b){d.push(b)});$.each(d,function(a,d){var h=d.eleRef;switch(h.constructor){case Toe.Model.SquareNoteSystem:h.controller.modifyZone(d.getCenterPoint().x,d.currentWidth),b.postModifySystemZone(h.systemId,Math.floor(h.zone.ulx/b.page.scale),Math.floor(h.zone.uly/b.page.scale),Math.floor(h.zone.lrx/
b.page.scale),Math.floor(h.zone.lry/b.page.scale)),h=h.getLooseElements(),0<h.length&&(h=$.map(h,function(a,b){return a.view.drawing}),h=new fabric.Group(h),b.rendEng.canvas.deactivateAll(),b.rendEng.canvas.setActiveGroup(h),b.deleteActiveSelection(b))}})};
Toe.View.SquareNoteInteraction.prototype.handleEventObjectSelected=function(a){this.unbindEditSubControls();this.removeEditSubControls();$("#btn_delete").toggleClass("disabled",!1);a=this.rendEng.canvas.getActiveObject().eleRef;if(a instanceof Toe.Model.Neume){if(this.showInfo("Selected: "+a.name+"<br/> Pitche(s): "+$.map(a.components,function(a){return a.pname.toUpperCase()+a.oct}).join(", ")),$("#btn_ungroup").toggleClass("disabled",!1),"punctum"==a.typeid||"cavum"==a.typeid||"virga"==a.typeid)this.insertEditNeumeSubControls(),
this.bindEditNeumeSubControls(a),this.initializeEditNeumeSubControls(a)}else a instanceof Toe.Model.Clef?(this.showInfo("Selected: "+a.name),this.insertEditClefSubControls(a),this.bindEditClefSubControls(a)):a instanceof Toe.Model.Division?this.showInfo("Selected: "+a.type):a instanceof Toe.Model.Custos?this.showInfo("Selected: Custos <br/> Pitch: "+a.pname.toUpperCase()+a.oct):a instanceof Toe.Model.System&&this.showInfo("Selected: system #"+a.orderNumber)};
Toe.View.SquareNoteInteraction.prototype.handleEventSelectionCleared=function(a){this.hideInfo();this.removeEditSubControls();$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_neumify_liquescence").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0)};
Toe.View.SquareNoteInteraction.prototype.handleEventSelectionCreated=function(a){a=a.target;a.hasControls=!1;a.borderColor="rgba(102,153,255,1.0)";var b=0,d=0,e=null;$.each(a.getObjects(),function(a,h){h.borderColor="rgba(0,0,0,0)";h.eleRef instanceof Toe.Model.Neume&&(e||(e=h.eleRef.system),d++,h.eleRef.system==e&&b++)});$("#btn_delete").toggleClass("disabled",!1);2>b?($("#btn_neumify").toggleClass("disabled",!0),$("#btn_neumify_liquescence").toggleClass("disabled",!0)):($("#btn_neumify").toggleClass("disabled",
!1),$("#btn_neumify_liquescence").toggleClass("disabled",!1));0<d?$("#btn_ungroup").toggleClass("disabled",!1):$("#btn_ungroup").toggleClass("disabled",!0)};Toe.View.SquareNoteInteraction.prototype.getOutputBoundingBox=function(a){var b=this;return $.map(a,function(a){return Math.round(a/b.page.scale)})};
Toe.View.SquareNoteInteraction.prototype.bindHotKeys=function(){var a=this;Mousetrap.bind(["del","backspace"],function(){$("#btn_delete").trigger("click.edit",{gui:a},a.handleDelete);return!1});Mousetrap.bind(["n","Ctrl+n","Command+n"],function(){$("#btn_neumify").trigger("click.edit",{gui:a},a.handleNeumify);return!1});Mousetrap.bind(["u","Ctrl+u","Command+u"],function(){$("#btn_ungroup").trigger("click.edit",{gui:a},a.handleUngroup);return!1})};
Toe.View.SquareNoteInteraction.prototype.insertEditControls=function(a){0===$("#sidebar-edit").length&&$(a).append('<span id="sidebar-edit"><br/><li class="divider"></li><li class="nav-header">Edit</li>\n<li>\n<button id="btn_delete" class="btn"><i class="icon-remove"></i> Delete</button>\n</li>\n<li>\n<div class="btn-group">\n<button id="btn_neumify" class="btn"><i class="icon-magnet"></i> Neumify</button>\n<button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>\n<ul class="dropdown-menu"><li><a id="btn_neumify_liquescence">liquescence</a></li></ul></li>\n<li><button id="btn_ungroup" class="btn"><i class="icon-share"></i> Ungroup</button></li>\n</div>\n</span>');
$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_neumify_liquescence").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0)};Toe.View.SquareNoteInteraction.prototype.insertEditNeumeSubControls=function(){0==$("#menu_editpunctum").length&&$("#sidebar-edit").append('<span id="menu_editpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="edit_chk_dot" class="btn">&#149; Dot</button>\n<button id="edit_chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="edit_chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li>\n<br/><li class="nav-header">Attributes</li>\n<li><div class="btn-group"><a class="btn dropdown-toggle" data-toggle="dropdown">\nHead shape <span class="caret"></span></a><ul class="dropdown-menu">\n<li><a id="head_punctum">punctum</a></li>\n<li><a id="head_punctum_inclinatum">punctum inclinatum</a></li>\n<li><a id="head_punctum_inclinatum_parvum">punctum inclinatum parvum</a></li>\n<li><a id="head_cavum">cavum</a></li>\n<li><a id="head_virga">virga</a></li>\n<li><a id="head_quilisma">quilisma</a></li>\n</ul></div></span>')};
Toe.View.SquareNoteInteraction.prototype.insertEditClefSubControls=function(a){0==$("#menu_editclef").length&&$("#sidebar-edit").append('<span id="menu_editclef"><br/><li class="nav-header">Clef</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="edit_rad_c" class="btn">C</button>\n<button id="edit_rad_f" class="btn">F</button>\n</div></li></span>');"c"==a.shape?$("#edit_rad_c").toggleClass("active",!0):$("#edit_rad_f").toggleClass("active",!0)};
Toe.View.SquareNoteInteraction.prototype.insertInsertControls=function(a){0==$("#sidebar-insert").length&&$(a).append('<span id="sidebar-insert"><br/><li class="divider"></li><li class="nav-header">Insert</li>\n<li><div class="btn-group" data-toggle="buttons-radio"><button id="rad_punctum" class="btn"><b>\u25a0</b> Punctum</button>\n<button id="rad_division" class="btn"><b>||</b> Division</button>\n<button id="rad_system" class="btn"><b><i class="icon-align-justify icon-black"></i></b>System</button>\n<button id="rad_clef" class="btn"><b>C/F</b> Clef</button>\n</div>\n</li>\n</span>');
$("#rad_punctum").bind("click.insert",{gui:this},this.handleInsertPunctum);$("#rad_division").bind("click.insert",{gui:this},this.handleInsertDivision);$("#rad_system").bind("click.insert",{gui:this},this.handleInsertSystem);$("#rad_clef").bind("click.insert",{gui:this},this.handleInsertClef);$("#rad_punctum").trigger("click")};Toe.View.SquareNoteInteraction.prototype.unbindEditClefSubControls=function(){$("#edit_rad_c").unbind("click");$("#edit_rad_f").unbind("click")};
Toe.View.SquareNoteInteraction.prototype.bindEditClefSubControls=function(a){$("#edit_rad_c").bind("click.edit",{gui:this,clef:a,shape:"c"},this.handleClefShapeChange);$("#edit_rad_f").bind("click.edit",{gui:this,clef:a,shape:"f"},this.handleClefShapeChange)};
Toe.View.SquareNoteInteraction.prototype.unbindEditNeumeSubControls=function(){$("#edit_chk_dot").unbind("click");$("#head_punctum").unbind("click");$("#head_cavum").unbind("click");$("#head_virga").unbind("click");$("#head_quilisma").unbind("click");$("#head_punctum_inclinatum").unbind("click");$("#head_punctum_inclinatum_parvum").unbind("click")};
Toe.View.SquareNoteInteraction.prototype.unbindEditSubControls=function(){$("#edit_chk_dot").unbind("click");$("#head_punctum").unbind("click");$("#head_cavum").unbind("click");$("#head_virga").unbind("click");$("#head_quilisma").unbind("click");$("#head_punctum_inclinatum").unbind("click");$("#head_punctum_inclinatum_parvum").unbind("click");$("#edit_rad_c").unbind("click");$("#edit_rad_f").unbind("click")};
Toe.View.SquareNoteInteraction.prototype.bindEditNeumeSubControls=function(a){$("#head_punctum").bind("click.edit",{gui:this,punctum:a,shape:"punctum"},this.handleHeadShapeChange);$("#head_cavum").bind("click.edit",{gui:this,punctum:a,shape:"cavum"},this.handleHeadShapeChange);$("#head_virga").bind("click.edit",{gui:this,punctum:a,shape:"virga"},this.handleHeadShapeChange);$("#head_quilisma").bind("click.edit",{gui:this,punctum:a,shape:"quilisma"},this.handleHeadShapeChange);$("#head_punctum_inclinatum").bind("click.edit",
{gui:this,punctum:a,shape:"punctum_inclinatum"},this.handleHeadShapeChange);$("#head_punctum_inclinatum_parvum").bind("click.edit",{gui:this,punctum:a,shape:"punctum_inclinatum_parvum"},this.handleHeadShapeChange);$("#edit_chk_dot").bind("click.edit",{gui:this,punctum:a},this.handleDotToggle)};Toe.View.SquareNoteInteraction.prototype.initializeEditNeumeSubControls=function(a){a.components[0].hasOrnament("dot")?$("#edit_chk_dot").toggleClass("active",!0):$("#edit_chk_dot").toggleClass("active",!1)};
Toe.View.SquareNoteInteraction.prototype.removeInsertSubControls=function(){$("#menu_insertdivision").remove();$("#menu_insertclef").remove();$("#menu_insertpunctum").remove();$("#menu_insertsystem").remove();this.divisionDwg&&this.rendEng.canvas.remove(this.divisionDwg);this.clefDwg&&this.rendEng.canvas.remove(this.clefDwg);this.punctDwg&&this.rendEng.canvas.remove(this.punctDwg);this.systemDrawing&&this.rendEng.canvas.remove(this.systemDrawing)};
Toe.View.SquareNoteInteraction.prototype.unbindInsertControls=function(){$("#rad_punctum").unbind("click");$("#rad_division").unbind("click");$("#rad_system").unbind("click");$("#rad_clef").unbind("click")};Toe.View.SquareNoteInteraction.prototype.removeEditSubControls=function(){$("#menu_editclef").remove();$("#menu_editpunctum").remove()};Toe.View.SquareNoteInteraction.prototype.unbindEditControls=function(){$("#btn_delete").unbind("click.edit");$("#btn_neumify").unbind("click.edit")};
Toe.View.SquareNoteInteraction.prototype.insertInsertSystemSubControls=function(){0==$("#menu_insertsystem").length&&($("#sidebar-insert").append('<span id="menu_insertsystem"><br/>\n<li class="nav-header">System Number</li>\n<li><div><input id="system_number_slider" type="range" min="1" max="1" step="1" value="1"> <output id="system_number"></output></div></li></span>'),$("#system_number_slider").change(function(){$("#system_number").html(this.value)}).change())};
Toe.View.SquareNoteInteraction.prototype.updateInsertSystemSubControls=function(){$("#system_number_slider").attr("max",this.page.systems.length+1);$("#system_number_slider").val(this.page.systems.length+1);$("#system_number_slider").change()};Toe.Model.SquareNoteNeumeComponent=function(a,b,d){Toe.Model.NeumeComponent.call(this,d);this.setHeadShape(this.props.type);this.setPitchInfo(a,b);this.pitchDiff=null};Toe.Model.SquareNoteNeumeComponent.prototype=new Toe.Model.NeumeComponent;Toe.Model.SquareNoteNeumeComponent.prototype.constructor=Toe.Model.SquareNoteNeumeComponent;
Toe.Model.SquareNoteNeumeComponent.prototype.setHeadShape=function(a){this.props.type=a.toLowerCase();this.props.name=Toe.Model.NeumeComponent.Type[this.props.type];if(void 0==this.props.name)throw Error("NeumeComponent: undefined head shape");};Toe.Model.SquareNoteNeumeComponent.prototype.setPitchDifference=function(a){this.pitchDiff=a};Toe.Model.SquareNoteNeumeComponent.prototype.setPitchInfo=function(a,b){this.pname=a;this.oct=b};
Toe.Model.SquareNoteNeumeComponent.prototype.hasOrnament=function(a){return $.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()}).length};Toe.Model.SquareNoteNeumeComponent.prototype.addOrnament=function(a){if(!(a instanceof Toe.Model.Ornament))throw Error("NeumeComponent: Invalid ornament");this.hasOrnament(a.key)||this.props.ornaments.push(a)};
Toe.Model.SquareNoteNeumeComponent.prototype.removeOrnament=function(a){this.props.ornaments=$.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()},!0)};Toe.Model.SquareNoteNeume=function(a){Toe.Model.Neume.call(this,a);this.rootSystemPos=null};Toe.Model.SquareNoteNeume.prototype=new Toe.Model.Neume;Toe.Model.SquareNoteNeume.prototype.constructor=Toe.Model.SquareNoteNeume;Toe.Model.SquareNoteNeume.SearchTree=new SearchTree;Toe.Model.SquareNoteNeume.SearchTree.populateFromJSON('{"rootNode":{"payload":{"typeid":"punctum","name":"Punctum"},"children":{"0":{"payload":{"typeid":"distropha","name":"Distropha"},"children":{"0":{"payload":{"typeid":"tristropha","name":"Tristropha"},"children":{},"numChildren":0}},"numChildren":1},"1":{"payload":{"typeid":"podatus","name":"Podatus"},"children":{"1":{"payload":{"typeid":"scandicus.1","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.2","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.3","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.4","name":"Scandicus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"scandicus.flexus.3","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.2","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.1","name":"Scandicus Flexus"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.1","name":"Scandicus Subpunctis"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.2","name":"Scandicus Subpunctis"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"torculus","name":"Torculus"},"children":{"1":{"payload":{"typeid":"torculus.resupinus.1","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.2","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.3","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.4","name":"Torculus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":1},"-1":{"payload":{"typeid":"podatus.subpunctis.1","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.1","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.2","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.2","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.3","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.3","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.4","name":"Podatus Subpunctis"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2},"-1":{"payload":{"typeid":"clivis","name":"Clivis"},"children":{"1":{"payload":{"typeid":"porrectus","name":"Porrectus"},"children":{"1":{"payload":{"typeid":"compound.2","name":"Compound"},"children":{"-1":{"payload":{"typeid":"compound.1","name":"Compound"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"porrectus.flexus","name":"Porrectus Flexus"},"children":{"-1":{"payload":{"typeid":"porrectus.subpunctis.1","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.1","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"porrectus.subpunctis.2","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.2","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"climacus.1","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.1","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.2","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.2","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.3","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.3","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.4","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.4","name":"Climacus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":3},"numNodes":1}');
Toe.Model.SquareNoteNeume.prototype.getRootPitchInfo=function(){var a=null,b=null;0<this.components.length&&(a=this.components[0].pname,b=this.components[0].oct);return{pname:a,oct:b}};Toe.Model.SquareNoteNeume.prototype.getPitchInfo=function(){var a=[];$.each(this.components,function(b,d){a.push({pname:d.pname,oct:d.oct})});return a};
Toe.Model.SquareNoteNeume.prototype.setRootSystemPos=function(a){if(this.rootSystemPos!=a){this.rootSystemPos=a;var b=this.system.getActingClefByEle(this);this.system.calcPitchFromSystemPos(this.rootSystemPos,b);var d=this;$.each(this.components,function(a,f){var h=d.system.calcPitchFromSystemPos(d.rootSystemPos+f.pitchDiff,b);f.setPitchInfo(h.pname,h.oct)});this.syncDrawing()}};
Toe.Model.SquareNoteNeume.prototype.neumeFromMei=function(a,b){if("neume"!=a.nodeName.toLowerCase())throw Error("neumeFromMei: invalid neume data");this.id=$(a).attr("xml:id");var d=$(a).attr("name").toLowerCase();"epiphonus"==d?(d="podatus",this.props.modifier="liquescence"):"cephalicus"==d&&(d="clivis",this.props.modifier="liquescence");this.setBoundingBox(b);var e=this;$(a).find("note").each(function(a,b){var c=$(b).attr("pname"),q=parseInt($(b).attr("oct")),k="punctum";"true"==$(this).parent().attr("inclinatum")?
k="true"==$(this).parent().attr("deminutus")?"punctum_inclinatum_parvum":"punctum_inclinatum":"true"==$(this).parent().attr("quilisma")?k="quilisma":"virga"==d||"bivirga"==d||"trivirga"==d?k="virga":"cavum"==d&&(k="cavum");var m=[],l=$("> dot",this).attr("form");l&&m.push(new Toe.Model.Ornament("dot",{form:l}));c=new Toe.Model.SquareNoteNeumeComponent(c,q,{type:k,ornaments:m});e.addComponent(c)});return this};
Toe.Model.SquareNoteNeume.prototype.getDifferences=function(){for(var a=[],b=1;b<this.components.length;b++)a.push(this.components[b].pitchDiff);return a};Toe.Model.SquareNoteNeume.prototype.diffToMelodicMove=function(){var a=this.getDifferences(),b=0;return a=$.map(a,function(a,e){var f=0;a>b?f=1:a<b&&(f=-1);b=a;return f})};
Toe.Model.SquareNoteNeume.prototype.deriveName=function(a){var b={enforceHeadShapes:!0};$.extend(b,a);if(0==this.components.length)return"unknown";a=this.diffToMelodicMove();a=Toe.Model.SquareNoteNeume.SearchTree.search(a,!0);a.prefix?(this.neumePrefix=a.result.typeid,this.name="Compound",this.typeid="compound"):(this.neumePrefix=null,this.name=a.result.name,this.typeid=a.result.typeid);"punctum"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Virga",this.typeid="virga"):"distropha"==
this.typeid&&"virga"==this.components[0].props.type?(this.name="Bivirga",this.typeid="bivirga"):"tristropha"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Trivirga",this.typeid="trivirga"):"Punctum"==this.name&&"cavum"==this.components[0].props.type?(this.name="Cavum",this.typeid="cavum"):"Podatus"==this.name&&"liquescence"==this.props.modifier?(this.name="Epiphonus",this.typeid="epiphonus"):"Clivis"==this.name&&"liquescence"==this.props.modifier&&(this.name="Cephalicus",this.typeid=
"cephalicus");b.enforceHeadShapes&&this.enforceHeadShapes();return this.name};
Toe.Model.SquareNoteNeume.prototype.enforceHeadShapes=function(){switch(this.typeid){case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":for(var a=1;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "climacus.resupinus.1":case "climacus.resupinus.2":case "climacus.resupinus.3":case "climacus.resupinus.4":for(a=1;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.1":case "podatus.subpunctis.2":case "podatus.subpunctis.3":case "podatus.subpunctis.4":for(a=
2;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.resupinus.1":case "podatus.subpunctis.resupinus.2":case "podatus.subpunctis.resupinus.3":for(a=2;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "scandicus.subpunctis.1":case "scandicus.subpunctis.2":for(a=3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.1":case "porrectus.subpunctis.2":for(a=
3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.resupinus.1":case "porrectus.subpunctis.resupinus.2":for(a=3;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "torculus.resupinus.3":case "torculus.resupinus.4":for(a=4;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum")}};Toe.Model.SquareNotePage=function(a){this.documentType=a};Toe.Model.SquareNotePage.prototype=new Toe.Model.Page;Toe.Model.SquareNotePage.prototype.constructor=Toe.SquareNotePage;
Toe.Model.SquareNotePage.prototype.loadMei=function(a,b){var d=this,e=$($(a).find("layer")[0]).attr("xml:id");this.setID(e);var f=$(a).find("surface")[0],h=$("clef, sb",a),c=[];$(h).each(function(a,b){$(b).is("sb")&&c.push(a)});var q=$("neume, sb",a),k=[];$(q).each(function(a,b){$(b).is("sb")&&k.push(a)});var m=$("division, sb",a),l=[];$(m).each(function(a,b){$(b).is("sb")&&l.push(a)});var g=$("custos, sb",a),p=[];$(g).each(function(a,b){$(b).is("sb")&&p.push(a)});$("sb",a).each(function(e,r){var u=
$(r).attr("systemref");if(u)var t=$($(a).find("system[xml\\:id="+u+"]")[0]).attr("facs");else t=$(r).attr("facs"),u=$(r).attr("xml:id");var t=$(f).find("zone[xml\\:id="+t+"]")[0],t=d.parseBoundingBox(t),v=new Toe.Model.SquareNoteSystem(t,null,d);v.setID($(r).attr("xml:id"));v.setOrderNumber(parseInt($(r).attr("n")));v.setSystemID(u);0==e&&b.calcScaleFromSystem(v,{overwrite:!0});u=new Toe.View.SystemView(b);new Toe.Ctrl.SystemController(v,u);d.addSystem(v);$(h).slice(c[e]+1,c[e+1]).each(function(a,
c){var e=$(c).attr("shape"),g=Math.round(2*parseFloat($(c).attr("line")))/2,g=2*-(v.props.numLines-g),h=$(c).attr("facs"),h=$(f).find("zone[xml\\:id="+h+"]")[0],h=d.parseBoundingBox(h),e=new Toe.Model.Clef(e,{systemPos:g});e.setID($(c).attr("xml:id"));e.setBoundingBox(h);g=new Toe.View.ClefView(b);new Toe.Ctrl.ClefController(e,g);v.addClef(e)});$(q).slice(k[e]+1,k[e+1]).each(function(a,c){var e=new Toe.Model.SquareNoteNeume,g=$(f).find("zone[xml\\:id="+$(c).attr("facs")+"]")[0],g=d.parseBoundingBox(g);
e.neumeFromMei(c,g);g=new Toe.View.NeumeView(b,d.documentType);new Toe.Ctrl.NeumeController(e,g);v.addNeume(e)});$(m).slice(l[e]+1,l[e+1]).each(function(a,c){var e=$(f).find("zone[xml\\:id="+$(c).attr("facs")+"]")[0],e=d.parseBoundingBox(e),g="div_"+$(c).attr("form"),g=new Toe.Model.Division(g);g.setBoundingBox(e);g.setID($(c).attr("xml:id"));e=new Toe.View.DivisionView(b);new Toe.Ctrl.DivisionController(g,e);v.addDivision(g)});$(g).slice(p[e]+1,p[e+1]).each(function(a,c){var e=$(f).find("zone[xml\\:id="+
$(c).attr("facs")+"]")[0],e=d.parseBoundingBox(e),g=$(c).attr("pname"),h=parseInt($(c).attr("oct")),g=new Toe.Model.Custos(g,h);g.setBoundingBox(e);g.setID($(c).attr("xml:id"));e=new Toe.View.CustosView(b);new Toe.Ctrl.CustosController(g,e);v.setCustos(g)})})};Toe.Model.SquareNoteSystem=function(a,b,d){if(!d)throw Error("Page object is required for square-note system.");Toe.Model.System.call(this,a,b);this.page=d};Toe.Model.SquareNoteSystem.prototype=new Toe.Model.System;Toe.Model.SquareNoteSystem.prototype.constructor=Toe.Model.SquareNoteSystem;
Toe.Model.SquareNoteSystem.prototype.getActingClefByCoords=function(a){var b=Toe.Model.System.prototype.getActingClefByCoords;a=b.call(this,a);for(var d=this;!a;)if(d=d.page.getPreviousSystem(d))a=b.call(d,{x:d.zone.lrx});else break;return a};
Toe.Model.SquareNoteSystem.prototype.getActingClefByEle=function(a){var b=Toe.Model.System.prototype.getActingClefByCoords;a=Toe.Model.System.prototype.getActingClefByEle.call(this,a);for(var d=this;!a;)if(d=d.page.getPreviousSystem(d))a=b.call(d,{x:d.zone.lrx});else break;return a};
Toe.Model.SquareNoteSystem.prototype.getPitchedElements=function(a){var b={clef:null,neumes:!0,custos:!0};$.extend(b,a);a=[];if(b.clef)for(var d=$.inArray(b.clef,this.elements)+1;d<this.elements.length&&!(this.elements[d]instanceof Toe.Model.Clef);d++){var e=this.elements[d];(e instanceof Toe.Model.Neume&&b.neumes||e instanceof Toe.Model.Custos&&b.custos)&&a.push(e)}else a=$.grep(this.elements,function(a){if(a instanceof Toe.Model.Neume&&b.neumes||a instanceof Toe.Model.Custos&&b.custos)return a});
for(var f=!1,h=this;h=this.page.getNextSystem(h);){for(var c=h.elements.length,d=0;d<c;d++)if(e=h.elements[d],e instanceof Toe.Model.Neume&&b.neumes||e instanceof Toe.Model.Custos&&b.custos)a.push(e);else if(e instanceof Toe.Model.Clef){f=!0;break}if(f)break}return a};
Toe.Model.SquareNoteSystem.prototype.calcPitchFromSystemPos=function(a,b){var d=a-b.props.systemPos,e=Toe.neumaticChroma.length,f=$.inArray(b.shape,Toe.neumaticChroma),h=(f+d)%e;0>h&&(h+=e);var c=Toe.neumaticChroma[h],q=$.inArray("c",Toe.neumaticChroma),e=$.truncateFloat(d/e);0<d&&h>=q&&h<f?e++:0>d&&(h<q||h>f)&&e--;d=4;"f"==b.shape&&(d=3);return{pname:c,oct:d+e}};
Toe.Model.SquareNoteSystem.prototype.calcSystemPosFromPitch=function(a,b,d){var e=4;"f"==d.shape&&(e=3);var f=Toe.neumaticChroma.length,h=$.inArray(d.shape,Toe.neumaticChroma);a=$.inArray(a,Toe.neumaticChroma);var c=$.inArray("c",Toe.neumaticChroma);b=a-h+f*(b-e);a<c&&(b+=f);return d.props.systemPos+b};Toe.Model.SquareNoteSystem.prototype.calcPitchFromCoords=function(a){var b=Math.round((this.zone.uly-a.y)/(this.delta_y/2));a=this.getActingClefByCoords(a);return this.calcPitchFromSystemPos(b,a)};
Toe.Model.SquareNoteSystem.prototype.updatePitchedElements=function(a){var b={clef:null,neumes:!0,custos:!1};$.extend(b,a);var d=this;if(b.clef){a=this.getPitchedElements({clef:b.clef});if(this.custos&&a[a.length-1]==this.custos&&!b.custos){var e=this.calcSystemPosFromPitch(this.custos.pname,this.custos.oct,b.clef);this.custos.setRootSystemPos(e);a.pop()}$.each(a,function(a,c){d.updateElePitchInfo(c,{clef:b.clef})})}else{var f=null;$.each(this.elements,function(a,c){if(c instanceof Toe.Model.Clef)f=
c;else if(f&&(c instanceof Toe.Model.Neume&&b.neumes||c==this.custos&&b.custos))d.updateElePitchInfo(c,{clef:f});else if(this.custos&&c==this.custos&&!b.custos){var e=this.calcSystemPosFromPitch(this.custos.pname,this.custos.oct,f);this.custos.setRootSystemPos(e)}})}};
Toe.Model.SquareNoteSystem.prototype.updateElePitchInfo=function(a,b){var d={clef:null};$.extend(d,b);d.clef||(d.clef=this.getActingClefByEle(a));var e=this;if(a instanceof Toe.Model.Neume)$.each(a.components,function(b,c){var f=e.calcPitchFromSystemPos(a.rootSystemPos+c.pitchDiff,d.clef);c.setPitchInfo(f.pname,f.oct)});else if(a instanceof Toe.Model.Custos){var f=this.calcPitchFromSystemPos(a.rootSystemPos,d.clef);a.setRootNote(f.pname,f.oct)}};
Toe.Model.SquareNoteSystem.prototype.addClef=function(a,b){if(!(a instanceof Toe.Model.Clef))throw Error("Toe.Model.SquareNoteSystem: Invalid clef");var d={justPush:!1};$.extend(d,b);var e=null;d.justPush?(this.elements.push(a),e=this.elements.length-1):e=this.insertElement(a);a.setSystem(this);this.updatePitchedElements({clef:a,custos:!1});$(a).trigger("vRenderClef",[a]);return e};
Toe.Model.SquareNoteSystem.prototype.setCustos=function(a){if(!(a instanceof Toe.Model.Custos))throw Error("Toe.Model.SquareNoteSystem: Invalid Custos");var b=this.getActingClefByCoords({x:a.zone.ulx});b&&(a.rootSystemPos=this.calcSystemPosFromPitch(a.pname,a.oct,b),0<this.elements.length&&this.elements[this.elements.length-1]instanceof Toe.Model.Custos?this.elements[this.elements.length-1]=a:this.elements.push(a),a.setSystem(this),this.custos=a,$(a).trigger("vRenderCustos",[a]));return this.elements.length-
1};
Toe.Model.SquareNoteSystem.prototype.addNeume=function(a,b){if(!(a instanceof Toe.Model.Neume))throw Error("Toe.Model.SquareNoteSystem: Invalid neume");var d={justPush:!1};$.extend(d,b);var e=this.getActingClefByCoords({x:a.zone.ulx});if(e){a.getRootPitchInfo();a.rootSystemPos=this.calcSystemPosFromPitch(a.components[0].pname,a.components[0].oct,e);a.components[0].setPitchDifference(0);for(var f=1;f<a.components.length;f++){var h=a.components[f];h.setPitchDifference(this.calcSystemPosFromPitch(h.pname,h.oct,
e)-a.rootSystemPos)}e=null;d.justPush?(this.elements.push(a),e=this.elements.length-1):e=this.insertElement(a);a.setSystem(this);$(a).trigger("vRenderNeume",[a]);return e}return null};
Toe.Model.SquareNoteSystem.prototype.addDivision=function(a,b){if(!(a instanceof Toe.Model.Division))throw Error("Toe.Model.SquareNoteSystem: invalid division");var d={justPush:!1};$.extend(d,b);var e=null;d.justPush?(this.elements.push(a),e=this.elements.length-1):e=this.insertElement(a);a.setSystem(this);$(a).trigger("vRenderDivision",[a]);return e};Toe.View.CheironomicInteraction=function(a,b,d,e){Toe.View.Interaction.call(this,a,b,d,e);b={initMode:"edit"};$.extend(b,e);this.punctDwg=null;e=a.getGlyph("punctum").clone();this.punctWidth=e.width*a.getGlobalScale();this.punctHeight=e.height*a.getGlobalScale();this.objMoving=!1;$("#btn_edit").bind("click.edit",{gui:this,parentDivId:"#gui-sidebar"},this.handleEdit);$("#btn_insert").bind("click.insert",{gui:this,parentDivId:"#gui-sidebar"},this.handleInsert);$("#btn_"+b.initMode).trigger("click");
this.bindHotKeys()};Toe.View.CheironomicInteraction.prototype=new Toe.View.Interaction;Toe.View.CheironomicInteraction.prototype.constructor=Toe.View.CheironomicInteraction;
Toe.View.CheironomicInteraction.prototype.handleEdit=function(a){var b=a.data.gui;b.activateCanvasObjects();b.hideInfo();b.removeInsertControls();b.unbindEventHandlers();b.insertEditControls(a.data.parentDivId);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.rendEng.repaint();b.rendEng.canvas.observe("mouse:down",function(a){b.downCoords=b.rendEng.canvas.getPointer(a.e)});b.rendEng.canvas.observe("object:moving",function(a){b.objMoving=!0});b.rendEng.canvas.observe("selection:created",function(a){a=
a.target;a.hasControls=!1;a.borderColor="rgba(102,153,255,1.0)";var b=0,f=0,h=null;$.each(a.getObjects(),function(a,d){d.borderColor="rgba(0,0,0,0)";d.eleRef instanceof Toe.Model.Neume&&(h||(h=d.eleRef.system),f++,d.eleRef.system==h&&b++)});$("#btn_delete").toggleClass("disabled",!1);2>b?$("#btn_neumify").toggleClass("disabled",!0):($("#btn_neumify").toggleClass("disabled",!1),$("#btn_neumify_liquescence_aug").toggleClass("disabled",!1),$("#btn_neumify_liquescence_dim").toggleClass("disabled",!1));
0<f?$("#btn_ungroup").toggleClass("disabled",!1):$("#btn_ungroup").toggleClass("disabled",!0)});b.rendEng.canvas.observe("object:selected",function(a){$("#btn_delete").toggleClass("disabled",!1);a=b.rendEng.canvas.getActiveObject().eleRef;a instanceof Toe.Model.Neume?(b.showInfo("Selected: "+a.name),$("#btn_ungroup").toggleClass("disabled",!1),$("#menu_editclef").remove(),"punctum"==a.typeid||"tractulus"==a.typeid||"cavum"==a.typeid||"virga"==a.typeid||"gravis"==a.typeid||"oriscus"==a.typeid||"stropha"==
a.typeid?(0==$("#menu_editpunctum").length&&$("#sidebar-edit").append('<span id="menu_editpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="edit_chk_dot" class="btn">&#149; Dot</button>\n<button id="edit_chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="edit_chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li>\n<br/><li class="nav-header">Attributes</li>\n<li><div class="btn-group"><a class="btn dropdown-toggle" data-toggle="dropdown">\nHead shape <span class="caret"></span></a><ul class="dropdown-menu">\n<li><a id="head_punctum">punctum</a></li>\n<li><a id="head_tractulus">tractulus</a></li>\n<li><a id="head_virga">virga</a></li>\n<li><a id="head_gravis">gravis</a></li>\n<li><a id="head_oriscus">oriscus</a></li>\n<li><a id="head_stropha">stropha</a></li>\n<li><a id="head_quilisma">quilisma</a></li>\n</ul></div></span>'),
a.components[0].hasOrnament("dot")?$("#edit_chk_dot").toggleClass("active",!0):$("#edit_chk_dot").toggleClass("active",!1),$("#edit_chk_dot").unbind("click"),$("#edit_chk_dot").bind("click.edit",{gui:b,punctum:a},b.handleDotToggle),$("#head_punctum").unbind("click"),$("#head_tractulus").unbind("click"),$("#head_virga").unbind("click"),$("#head_quilisma").unbind("click"),$("#head_punctum").bind("click.edit",{gui:b,punctum:a,shape:"punctum"},b.handleHeadShapeChange),$("#head_tractulus").bind("click.edit",
{gui:b,punctum:a,shape:"tractulus"},b.handleHeadShapeChange),$("#head_virga").bind("click.edit",{gui:b,punctum:a,shape:"virga"},b.handleHeadShapeChange),$("#head_gravis").bind("click.edit",{gui:b,punctum:a,shape:"gravis"},b.handleHeadShapeChange),$("#head_oriscus").bind("click.edit",{gui:b,punctum:a,shape:"oriscus"},b.handleHeadShapeChange),$("#head_stropha").bind("click.edit",{gui:b,punctum:a,shape:"stropha"},b.handleHeadShapeChange),$("#head_quilisma").bind("click.edit",{gui:b,punctum:a,shape:"quilisma"},
b.handleHeadShapeChange)):$("#menu_editpunctum").remove()):$("#menu_editpunctum").remove()});b.rendEng.canvas.observe("selection:cleared",function(a){b.hideInfo();$("#menu_editpunctum").remove();$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_neumify_liquescence_aug").toggleClass("disabled",!0);$("#btn_neumify_liquescence_dim").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0)});b.rendEng.canvas.observe("mouse:up",function(a){b.rendEng.canvas.getPointer(a.e);
if(b.objMoving){(a=b.rendEng.canvas.getActiveObject())||(a=b.rendEng.canvas.getActiveGroup());if(a){var e=[];a.eleRef?e.push(a):$.each(a.objects,function(a,b){e.push(b)});$.each(e,function(a,d){var c=d.eleRef;if(c instanceof Toe.Model.Neume){var q={x:d.left,y:d.top},k=b.page.getClosestSystem(q),q=k.getSystemSnapCoordinates(q,d.currentWidth,{ignoreEle:c,y:!1}),m=q.x-d.currentWidth/2,l=q.y-d.currentHeight/2,g=m+d.currentWidth,p=l+d.currentWidth;c.setBoundingBox([m,l,g,p]);$(c).trigger("vEraseDrawing");
c.system.removeElementByRef(c);q=k.addNeume(c);1==e.length&&$(c).trigger("vSelectDrawing");m=b.getOutputBoundingBox([m,l,g,p]);c={id:c.id,ulx:m[0],uly:m[1],lrx:m[2],lry:m[3],pitchInfo:null};q+1<k.elements.length?c.beforeid=k.elements[q+1].id:(k=b.page.getNextSystem(k),c.beforeid=k.id);$.post(b.apiprefix+"/move/neume",{data:JSON.stringify(c)}).error(function(){b.showAlert("Server failed to move neume. Client and server are not synchronized.")})}});1<e.length&&b.rendEng.canvas.discardActiveGroup();
b.rendEng.repaint()}b.objMoving=!1}});$("#btn_delete").unbind("click");$("#btn_neumify").unbind("click");$("#btn_ungroup").unbind("click");$("#btn_delete").bind("click.edit",{gui:b},b.handleDelete);$("#btn_neumify").bind("click.edit",{gui:b},b.handleNeumify);$("#btn_neumify_liquescence_aug").bind("click.edit",{gui:b,modifier:"aug"},b.handleNeumify);$("#btn_neumify_liquescence_dim").bind("click.edit",{gui:b,modifier:"dim"},b.handleNeumify);$("#btn_ungroup").bind("click.edit",{gui:b},b.handleUngroup)};
Toe.View.CheironomicInteraction.prototype.handleDotToggle=function(a){var b=a.data.gui,d=a.data.punctum;if(a=d.components[0].hasOrnament("dot"))d.components[0].removeOrnament("dot");else{var e=new Toe.Model.Ornament("dot",{form:"aug"});d.components[0].addOrnament(e)}d.syncDrawing();e=b.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);d={id:d.id,dotform:"aug",ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]};a?$.post(b.apiprefix+"/delete/dot",d).error(function(){b.showAlert("Server failed to remove dot from the punctum. Client and server are not synchronized.")}):
$.post(b.apiprefix+"/insert/dot",d).error(function(){b.showAlert("Server failed to add a dot to the punctum. Client and server are not synchronized.")});$(this).toggleClass("active")};
Toe.View.CheironomicInteraction.prototype.handleHeadShapeChange=function(a){var b=a.data.gui,d=a.data.shape;a=a.data.punctum;a.components[0].setHeadShape(d);switch(d){case "punctum":a.name="Punctum";a.typeid="punctum";break;case "tractulus":a.name="Tractulus";a.typeid="tractulus";break;case "virga":a.name="Virga";a.typeid="virga";break;case "gravis":a.name="Gravis";a.typeid="gravis";break;case "oriscus":a.name="Oriscus";a.typeid="oriscus";break;case "stropha":a.name="Stropha",a.typeid="stropha"}a.syncDrawing();
var e=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/update/neume/headshape",{id:a.id,shape:d,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){b.showAlert("Server failed to change note head shape. Client and server are not synchronized.")})};
Toe.View.CheironomicInteraction.prototype.handleDelete=function(a){var b=a.data.gui,d=[],e=function(a){a=a.eleRef;a.system.removeElementByRef(a);d.push(a.id);b.rendEng.canvas.discardActiveObject()};if(a=b.rendEng.canvas.getActiveObject())a.eleRef instanceof Toe.Model.Neume&&e(a),b.rendEng.repaint();else if(a=b.rendEng.canvas.getActiveGroup())$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&e(b)}),b.rendEng.canvas.discardActiveGroup(),b.rendEng.repaint();0<d.length&&$.post(b.apiprefix+
"/delete/neume",{ids:d.join(",")}).error(function(){b.showAlert("Server failed to delete neume. Client and server are not synchronized.")})};
Toe.View.CheironomicInteraction.prototype.handleNeumify=function(a){var b=a.data.gui;a=a.data.modifier;var d=b.rendEng.canvas.getActiveGroup();if(d){var e=[],f=null;$.each(d.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&(f||(f=b.eleRef.system),b.eleRef.system==f&&e.push(b))});if(!(2>e.length)){e.sort(function(a,b){return a.eleRef.zone.ulx-b.eleRef.zone.ulx});var h=new Toe.Model.CheironomicNeume({modifier:a});numPunct=0;var c=[],q=Number.MAX_VALUE,k=Number.MAX_VALUE,m=Number.MIN_VALUE,
l=null;$.each(e,function(a,e){$.merge(h.components,e.eleRef.components);c.push(e.eleRef.id);var g=d.left+e.left,n=d.top+e.top;if(0<a){var p=0;n<l?p=1:n>l&&(p=-1);h.components[numPunct].relativePitch=p}l=n;q=Math.min(q,g-e.currentHeight/2);k=Math.min(k,n-e.currentHeight/2);m=Math.max(m,n+e.currentHeight/2);numPunct+=e.eleRef.components.length;f.removeElementByRef(e.eleRef);b.rendEng.canvas.remove(e)});h.setBoundingBox([q,k,q+numPunct*b.punctWidth,m]);var g=new Toe.View.NeumeView(b.rendEng,b.page.documentType);
new Toe.Ctrl.NeumeController(h,g);f.addNeume(h);var g=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]),p=h.typeid,n=$.map(h.components,function(a){return a.props.type});a=JSON.stringify({nids:c.join(","),typeid:p,liquescence:a,headShapes:n,ulx:g[0],uly:g[1],lrx:g[2],lry:g[3]});$.post(b.apiprefix+"/neumify",{data:a},function(a){h.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to neumify selected neumes. Client and server are not synchronized.")});b.rendEng.canvas.discardActiveGroup();
"compound"!=h.typeid&&$(h).trigger("vSelectDrawing");b.rendEng.repaint()}}};
Toe.View.CheironomicInteraction.prototype.handleUngroup=function(a){var b=a.data.gui,d=[];(a=b.rendEng.canvas.getActiveObject())?a.eleRef instanceof Toe.Model.Neume&&1<a.eleRef.components.length&&d.push(a):(a=b.rendEng.canvas.getActiveGroup())&&$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&1<b.eleRef.components.length&&d.push(b)});var e=[],f=[],h=[];$.each(d,function(a,d){e.push(d.eleRef.id);var k=[],m=d.eleRef.zone.ulx;d.eleRef.system.removeElementByRef(d.eleRef);b.rendEng.canvas.remove(d);
$.each(d.eleRef.components,function(a,c){var e=new Toe.Model.CheironomicNeume;e.addComponent(c);var f=d.eleRef.zone.uly;d.eleRef.components[a].relativePitch&&(f+=-d.eleRef.components[a].relativePitch*b.punctHeight);e.setBoundingBox([m+a*b.punctWidth,f,m+(a+1)*b.punctWidth,f+b.punctHeight]);f=new Toe.View.NeumeView(b.rendEng,b.page.documentType);new Toe.Ctrl.NeumeController(e,f);d.eleRef.system.addNeume(e);f=b.getOutputBoundingBox([e.zone.ulx,e.zone.uly,e.zone.lrx,e.zone.lry]);k.push({ulx:f[0],uly:f[1],
lrx:f[2],lry:f[3]});h.push(e)});f.push(k)});a=JSON.stringify({nids:e.join(","),bbs:f});$.post(b.apiprefix+"/ungroup",{data:a},function(a){var b=JSON.parse(a).nids,b=$.map(b,function(a){return a});$.each(h,function(a,c){c.id=b[a]})}).error(function(){b.showAlert("Server failed to ungroup selected neumes. Client and server are not synchronized.")});b.rendEng.canvas.discardActiveObject();b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()};
Toe.View.CheironomicInteraction.prototype.handleInsert=function(a){var b=a.data.gui;a=a.data.parentDivId;b.deactivateCanvasObjects();b.hideInfo();b.removeInsertControls();b.removeEditControls();b.unbindEventHandlers();$("#btn_delete").unbind("click.edit");$("#btn_neumify").unbind("click.edit");$("#btn_ungroup").unbind("click.edit");0==$("#sidebar-insert").length&&$(a).append('<span id="sidebar-insert"><br/><li class="divider"></li><li class="nav-header">Insert</li>\n<li><div class="btn-group" data-toggle="buttons-radio"><button id="rad_punctum" class="btn"><i class="icon-bookmark icon-black"></i> Punctum</button>\n\n</div>\n</li>\n</span>');
$("#rad_punctum").unbind("click");$("#rad_punctum").bind("click.insert",{gui:b},b.handleInsertPunctum);$("#rad_punctum").trigger("click")};
Toe.View.CheironomicInteraction.prototype.handleInsertPunctum=function(a){var b=a.data.gui;b.unbindEventHandlers();0==$("#menu_insertpunctum").length&&$("#sidebar-insert").append('<span id="menu_insertpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="chk_dot" class="btn">&#149; Dot</button>\n<button id="chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li></span>');var d=
!1,e=function(a){var e={modify:[],fixed:[]},c=null,q=b.rendEng.getGlyph("punctum");a?c={left:-50,top:-50}:(c={left:b.punctDwg.left,top:b.punctDwg.top},d&&(a=b.rendEng.getGlyph("dot").clone().set({left:c.left+b.punctWidth,top:c.top+b.punctHeight/2,opacity:.6}),e.modify.push(a)));c=q.clone().set({left:c.left,top:c.top,opacity:.6});e.modify.push(c);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.punctDwg=b.rendEng.draw(e,{group:!0,selectable:!1,repaint:!0})[0]};e(!0);b.rendEng.canvas.observe("mouse:move",
function(a){a=b.rendEng.canvas.getPointer(a.e);b.punctDwg.left=a.x-b.punctDwg.currentWidth/4;b.punctDwg.top=a.y-b.punctDwg.currentHeight/4;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var e={x:b.punctDwg.left,y:b.punctDwg.top};a=b.page.getClosestSystem(e);var c=new Toe.Model.CheironomicNeume,q=a.getSystemSnapCoordinates(e,b.punctDwg.currentWidth,{y:!1}),e=q.x-b.punctDwg.currentWidth/2,q=q.y-b.punctDwg.currentHeight/2;c.setBoundingBox([e,q,e+b.punctDwg.currentWidth,q+b.punctDwg.currentHeight]);
e={};q=[];d&&(q.push(new Toe.Model.Ornament("dot",{form:"aug"})),e.dotform="aug");q=new Toe.Model.CheironomicNeumeComponent({type:"punctum",ornaments:q});c.addComponent(q);c.typeid=c.name="punctum";q=new Toe.View.NeumeView(b.rendEng,b.page.documentType);new Toe.Ctrl.NeumeController(c,q);var q=a.addNeume(c),k=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);e.ulx=k[0];e.uly=k[1];e.lrx=k[2];e.lry=k[3];if(q+1<a.elements.length)e.beforeid=a.elements[q+1].id;else if(a=b.page.getNextSystem(a))e.beforeid=
a.id;$.post(b.apiprefix+"/insert/neume",e,function(a){c.id=JSON.parse(a).id}).error(function(){b.showAlert("Server failed to insert neume. Client and server are not synchronized.")})});$("#chk_dot").bind("click.insert",function(){d=d?!1:!0;e(!1)})};Toe.View.CheironomicInteraction.prototype.getOutputBoundingBox=function(a){gui=this;return $.map(a,function(a){return Math.round(a/gui.page.scale)})};
Toe.View.CheironomicInteraction.prototype.bindHotKeys=function(){var a=this;Mousetrap.bind(["del","backspace"],function(){$("#btn_delete").trigger("click.edit",{gui:a},a.handleDelete);return!1});Mousetrap.bind(["n","Ctrl+n","Command+n"],function(){$("#btn_neumify").trigger("click.edit",{gui:a},a.handleNeumify);return!1});Mousetrap.bind(["u","Ctrl+u","Command+u"],function(){$("#btn_ungroup").trigger("click.edit",{gui:a},a.handleUngroup);return!1})};
Toe.View.CheironomicInteraction.prototype.insertEditControls=function(a){0==$("#sidebar-edit").length&&$(a).append('<span id="sidebar-edit"><br/><li class="divider"></li><li class="nav-header">Edit</li>\n<li>\n<button id="btn_delete" class="btn"><i class="icon-remove"></i> Delete</button>\n</li>\n<li>\n<div class="btn-group">\n<button id="btn_neumify" class="btn"><i class="icon-magnet"></i> Neumify</button>\n<button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>\n<ul class="dropdown-menu"><li><a id="btn_neumify_liquescence_aug">liquescence augmented</a></li>\n<li><a id="btn_neumify_liquescence_dim">liquescence diminished</a></li></ul></li>\n<li><button id="btn_ungroup" class="btn"><i class="icon-share"></i> Ungroup</button></li>\n</div>\n</span>');
$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0)};Toe.Model.CheironomicNeumeComponent=function(a){Toe.Model.NeumeComponent.call(this,a);this.relativePitch=null;this.setHeadShape(this.props.type)};Toe.Model.CheironomicNeumeComponent.prototype=new Toe.Model.NeumeComponent;Toe.Model.CheironomicNeumeComponent.prototype.constructor=Toe.Model.CheironomicNeumeComponent;
Toe.Model.CheironomicNeumeComponent.prototype.setHeadShape=function(a){this.props.type=a.toLowerCase();this.props.name=Toe.Model.NeumeComponent.Type[this.props.type];if(void 0==this.props.name)throw Error("NeumeComponent: undefined head shape");};Toe.Model.CheironomicNeume=function(a){Toe.Model.Neume.call(this,a)};Toe.Model.CheironomicNeume.prototype=new Toe.Model.Neume;Toe.Model.CheironomicNeume.prototype.constructor=Toe.Model.CheironomicNeume;Toe.Model.CheironomicNeume.SearchTree=new SearchTree;Toe.Model.CheironomicNeume.SearchTree.populateFromJSON('{"rootNode":{"payload":{"typeid":"punctum","name":"Punctum"},"children":{"1":{"payload":{"typeid":"pes","name":"Pes"},"children":{"1":{"payload":{"typeid":"scandicus.1","name":"Scandicus"},"children":{"-1":{"payload":{"typeid":"scandicus.flexus","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"torculus","name":"Torculus"},"children":{"1":{"payload":{"typeid":"torculus.resupinus.1","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.flexus","name":"Torculus Resupinus Flexus"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"pes.subbipunctis","name":"Pes Subbipunctis"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2},"-1":{"payload":{"typeid":"clivis","name":"Clivis"},"children":{"1":{"payload":{"typeid":"porrectus","name":"Porrectus"},"children":{"-1":{"payload":{"typeid":"porrectus.flexus","name":"Porrectus Flexus"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"climacus.1","name":"Climacus"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2},"numNodes":1}');
Toe.Model.CheironomicNeume.prototype.neumeFromMei=function(a,b){if("neume"!=a.nodeName.toLowerCase())throw Error("neumeFromMei: invalid neume data");this.id=$(a).attr("xml:id");var d=$(a).attr("name").toLowerCase(),e=$(a).attr("variant");e&&(e=e.toLowerCase(),this.props.modifier="liquescent"==e?Toe.Model.Neume.Modifier.alt:"liquescent_aug"==e?Toe.Model.Neume.Modifier.aug:"liquescent_dim"==e?Toe.Model.Neume.Modifier.dim:e);var f=$(a).find("note"),h=d;switch(d){case "virga":case "tractulus":case "gravis":case "oriscus":case "stropha":h=
"punctum";break;case "podatus":h=d="pes";break;case "epiphonus":h=d="pes";this.props.modifier="liquescence";break;case "cephalicus":h=d="clivis";this.props.modifier="liquescence";break;case "climacus":h+="."+(f.length-2);break;case "ancus":h="climacus.1";this.props.modifier="liquescence";break;case "scandicus":h+="."+(f.length-2);break;case "torculus":"resupinus"==e&&(h+=".resupinus"+(f.length-3))}this.setBoundingBox(b);var c=Toe.Model.CheironomicNeume.SearchTree.dfs(h);if(c.node&&f.length==c.edges.length+
1){var q=this;$(f).each(function(a,b){var e="punctum";"true"==$(this).parent().attr("quilisma")?e="quilisma":"virga"==d||"bivirga"==d||"trivirga"==d?e="virga":"tractulus"==d?e="tractulus":"gravis"==d?e="gravis":"oriscus"==d?e="oriscus":"stropha"==d&&(e="stropha");var f=[],h=$("> dot",this).attr("form");h&&f.push(new Toe.Model.Ornament("dot",{form:h}));e=new Toe.Model.CheironomicNeumeComponent({type:e,ornaments:f});0<a&&(e.relativePitch=parseInt(c.edges[a-1]));q.addComponent(e)});this.deriveName();
return this}};Toe.Model.CheironomicNeume.prototype.getRelativePitches=function(){for(var a=[],b=1;b<this.components.length;b++)a.push(this.components[b].relativePitch);return a};
Toe.Model.CheironomicNeume.prototype.deriveName=function(){if(0==this.components.length)return"unknown";var a=this.getRelativePitches(),a=Toe.Model.CheironomicNeume.SearchTree.search(a,!0);a.prefix?(this.neumePrefix=a.result.typeid,this.name="Compound",this.typeid="compound"):(this.neumePrefix=null,this.name=a.result.name,this.typeid=a.result.typeid);"punctum"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Virga",this.typeid="virga"):"punctum"==this.typeid&&"tractulus"==this.components[0].props.type?
(this.name="Tractulus",this.typeid="tractulus"):"punctum"==this.typeid&&"gravis"==this.components[0].props.type?(this.name="Gravis",this.typeid="gravis"):"punctum"==this.typeid&&"oriscus"==this.components[0].props.type?(this.name="Oriscus",this.typeid="oriscus"):"punctum"==this.typeid&&"stropha"==this.components[0].props.type?(this.name="Stropha",this.typeid="stropha"):"pes"==this.typeid&&"liquescence"==this.props.modifier?(this.name="Epiphonus",this.typeid="epiphonus"):"clivis"==this.typeid&&"liquescence"==
this.props.modifier?(this.name="Cephalicus",this.typeid="cephalicus"):"climacus"==this.typeid&&"liquescence"==this.props.modifier&&(this.name="Ancus",this.typeid="ancus");return this.name};Toe.Model.CheironomicPage=function(a){this.documentType=a};Toe.Model.CheironomicPage.prototype=new Toe.Model.Page;Toe.Model.CheironomicPage.prototype.constructor=Toe.Model.CheironomicPage;
Toe.Model.CheironomicPage.prototype.loadMei=function(a,b){var d=this,e=$(a).find("surface")[0],f=$(a).find("section")[0],h=$(f).children(),c=[];$(h).each(function(a,b){$(b).is("sb")&&c.push(a)});c.push(h.length);var q=0;$(c).each(function(a,m){var l=$(h).slice(q,m),g=new Toe.Model.CheironomicSystem([0,0,0,0],{numLines:0});g.setOrderNumber(parseInt($(m).attr("n")));var p=null,p=0==a?$(f).attr("xml:id"):$($(h)[c[a-1]]).attr("xml:id");g.setID(p);p=new Toe.View.SystemView(b);new Toe.Ctrl.SystemController(g,
p);d.addSystem(g);var n=Number.MAX_VALUE,r=0;$(l).each(function(c,f){var h=new Toe.Model.CheironomicNeume,l=$(e).find("zone[xml\\:id="+$(f).attr("facs")+"]")[0],l=d.parseBoundingBox(l);l[1]<n&&(n=l[1]);l[3]>r&&(r=l[3]);h.neumeFromMei(f,l);l=new Toe.View.NeumeView(b,d.documentType);new Toe.Ctrl.NeumeController(h,l);0==a&&0==c&&b.calcScaleFromNeume(h,{overwrite:!0});g.addNeume(h,{justPush:!0})});g.elements.length&&(g.setBoundingBox([g.elements[0].zone.ulx,n,g.elements[g.elements.length-1].zone.lrx,
r]),$(g).trigger("vRenderSystem",[g]));q=m+1})};Toe.Model.CheironomicSystem=function(a,b){Toe.Model.System.call(this,a,b)};Toe.Model.CheironomicSystem.prototype=new Toe.Model.System;Toe.Model.CheironomicSystem.prototype.constructor=Toe.Model.CheironomicSystem;
Toe.Model.CheironomicSystem.prototype.addNeume=function(a,b){if(!(a instanceof Toe.Model.Neume))throw Error("Toe.Model.CheironomicSystem: Invalid neume");var d={justPush:!1};$.extend(d,b);var e=null;d.justPush?(this.elements.push(a),e=this.elements.length-1):e=this.insertElement(a);a.setSystem(this);$(a).trigger("vRenderNeume",[a]);return e};var drawHartkerNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);var b=this.rendEng.getGlyph("dot"),d={fixed:[],modify:[]},e=null;switch(a.typeid){case "punctum":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):a.components[0].props.name==Toe.Model.NeumeComponent.Type.quilisma?this.rendEng.getGlyph("quilisma"):this.rendEng.getGlyph("punctum");break;case "tractulus":e=
"liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):this.rendEng.getGlyph("tractulus");break;case "virga":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("virga_liquescence_aug"):"strata"==a.props.modifier?this.rendEng.getGlyph("virga_strata"):this.rendEng.getGlyph("virga");break;case "gravis":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):this.rendEng.getGlyph("gravis");break;case "oriscus":e="liquescence_aug"==
a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):this.rendEng.getGlyph("oriscus");break;case "stropha":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):this.rendEng.getGlyph("stropha");break;case "quilisma":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):this.rendEng.getGlyph("quilisma");break;case "clivis":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("clivis_liquescence_aug"):"liquescence_dim"==
a.props.modifier?this.rendEng.getGlyph("virga_liquescence_aug"):this.rendEng.getGlyph("clivis");break;case "ancus":e=this.rendEng.getGlyph("clivis_liquescence_aug");break;case "cephalicus":e=this.rendEng.getGlyph("clivis_liquescence_aug");break;case "podatus":case "pes":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("pes_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("punctum_liquescence_aug"):"quassus"==a.props.modifier?this.rendEng.getGlyph("pes_quassus"):
this.rendEng.getGlyph("pes");break;case "epiphonus":e=this.rendEng.getGlyph("punctum_liquescence_aug");break;case "porrectus":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("porrectus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("porrectus_liquescence_dim"):this.rendEng.getGlyph("porrectus");break;case "torculus":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("torculus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("pes_liquescence_aug"):
this.rendEng.getGlyph("torculus");break;case "scandicus.1":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("scandicus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("scandicus_liquescence_dim"):this.rendEng.getGlyph("scandicus");break;case "climacus.1":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("climacus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("clivis_liquescence_aug"):this.rendEng.getGlyph("climacus");break;
case "torculus.resupinus.1":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("torculusresupinus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("torculusresupinus_liquescence_dim"):this.rendEng.getGlyph("torculusresupinus");break;case "torculus.resupinus.flexus":e="liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("torculusresupinus_liquescence_aug"):this.rendEng.getGlyph("torculusresupinusflexus");break;case "porrectus.flexus":e="liquescence_aug"==a.props.modifier?
this.rendEng.getGlyph("porrectusflexus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("porrectus_liquescence_aug"):this.rendEng.getGlyph("porrectusflexus");break;case "scandicus.flexus":e="liquescence_aug"==a.props.modifier?this.rendEng.getGlyph("scandicusflexus_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("scandicus_liquescence_aug"):this.rendEng.getGlyph("scandicusflexus");break;case "pes.subbipunctis":e="liquescence_aug"==a.props.modifier?
this.rendEng.getGlyph("pessubbipunctis_liquescence_aug"):"liquescence_dim"==a.props.modifier?this.rendEng.getGlyph("torculus_liquescence_aug"):this.rendEng.getGlyph("pessubbipunctis")}if(e){var f=a.zone.ulx+e.centre[0],h=a.zone.uly+e.centre[1],c=e.clone().set({left:f,top:h});d.modify.push(c);for(c=0;c<a.components.length;c++)a.components[c].hasOrnament("dot")&&d.modify.push(b.clone().set({left:f+2*e.centre[0],top:h+e.centre[1]}));this.drawing=this.rendEng.draw(d,{group:!0,selectable:a.props.interact,
eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)}};
